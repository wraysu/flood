// COPYRIGHT © 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","./bidiEngineTables"],(function(r,t,n){Object.defineProperty(t,"__esModule",{value:!0});var e=function(){function r(){this.inputFormat="ILYNN",this.outputFormat="VLNNN",this.sourceToTarget=[],this.targetToSource=[],this.levels=[]}return r.prototype.bidiTransform=function(r,t,e){if(this.sourceToTarget=[],this.targetToSource=[],!r)return"";if(function(r,t,n){m=[],F=[];for(var e=0;e<n;e++)r[e]=e,t[e]=e,m[e]=e}(this.sourceToTarget,this.targetToSource,r.length),!this.checkParameters(t,e))return r;t=this.inputFormat,e=this.outputFormat;var o=r,A=N,c=_(t.charAt(1)),h=_(e.charAt(1)),R=("I"===t.charAt(0)?"L":t.charAt(0))+c,S=("I"===e.charAt(0)?"L":e.charAt(0))+h,O=t.charAt(2)+e.charAt(2);A.defInFormat=R,A.defOutFormat=S,A.defSwap=O;var C=function r(t,n,e,o,f){var s=function(r,t,n){void 0===t.inFormat&&(t.inFormat=n.defInFormat);void 0===t.outFormat&&(t.outFormat=n.defOutFormat);void 0===t.swap&&(t.swap=n.defSwap);if(t.inFormat===t.outFormat)return t;var e,a=t.inFormat.substring(0,1),o=t.outFormat.substring(0,1),u=t.inFormat.substring(1,4),f=t.outFormat.substring(1,4);"C"===u.charAt(0)&&(e=i(r),u="ltr"===e||"rtl"===e?e.toUpperCase():"L"===t.inFormat.charAt(2)?"LTR":"RTL",t.inFormat=a+u);"C"===f.charAt(0)&&("rtl"===(e=i(r))?f="RTL":"ltr"===e?(e=function(r){var t=r.split("");return t.reverse(),i(t.join(""))}(r),f=e.toUpperCase()):f="L"===t.outFormat.charAt(2)?"LTR":"RTL",t.outFormat=o+f);return t}(t,{inFormat:n,outFormat:e,swap:o},f);if(s.inFormat===s.outFormat)return t;n=s.inFormat,e=s.outFormat,o=s.swap;var l=n.substring(0,1),T=n.substring(1,4),A=e.substring(0,1),c=e.substring(1,4);if(f.inFormat=n,f.outFormat=e,f.swap=o,"L"===l&&"VLTR"===e){if("LTR"===T)return f.dir=E,a(t,f);if("RTL"===T)return f.dir=w,a(t,f)}if("V"===l&&"V"===A)return f.dir="RTL"===T?w:E,u(t,f);if("L"===l&&"VRTL"===e)return"LTR"===T?(f.dir=E,t=a(t,f)):(f.dir=w,t=a(t,f)),u(t);if("VLTR"===n&&"LLTR"===e)return f.dir=E,a(t,f);if("V"===l&&"L"===A&&T!==c)return t=u(t),"RTL"===T?r(t,"LLTR","VLTR",o,f):r(t,"LRTL","VRTL",o,f);if("VRTL"===n&&"LRTL"===e)return r(t,"LRTL","VRTL",o,f);if("L"===l&&"L"===A){var h=f.swap;return f.swap=h.substr(0,1)+"N","RTL"===T?(f.dir=w,t=a(t,f),f.swap="N"+h.substr(1,2),f.dir=E,t=a(t,f)):(f.dir=E,t=a(t,f),f.swap="N"+h.substr(1,2),t=r(t,"VLTR","LRTL",f.swap,f)),t}return t}(r,R,S,O,A),V=!1;return"R"===e.charAt(1)?V=!0:"C"!==e.charAt(1)&&"D"!==e.charAt(1)||(V="rtl"===this.checkContextual(C)),this.sourceToTarget=m,this.targetToSource=function(r){for(var t=new Array(r.length),n=0;n<r.length;n++)t[r[n]]=n;return t}(this.sourceToTarget),p=this.targetToSource,o=t.charAt(3)===e.charAt(3)?C:"S"===e.charAt(3)?function(r,t,e){if(0===t.length)return"";void 0===r&&(r=!0);void 0===e&&(e=!0);var i=(t=String(t)).split(""),a=0,o=1,u=i.length;r||(a=i.length-1,o=-1,u=1);for(var A=function(r,t,e,i,a){for(var o=0,u=[],f=0,A=t;A*e<i;A+=e)if(s(r[A])||v(r[A])){if("ل"===r[A]&&T(r,A+e,e,i)){r[A]=d(r[A+e],0===o?n.LamAlefInialTableFE:n.LamAlefMedialTableFE),b(r,A+=e,e,i),a&&(u[f]=A,f++),o=0;continue}var c=r[A];1===o?r[A]=l(r,A+e,e,i)?U(r[A]):L(r[A],n.FinalForm):!0===l(r,A+e,e,i)?r[A]=L(r[A],n.InitialForm):r[A]=L(r[A],n.IsolatedForm),v(c)||(o=1),!0===B(c)&&(o=0)}else o=0;return u}(i,a,o,u,e),c="",h=0;h<i.length;h++)e&&f(A,A.length,h)>-1?(g(p,h,!r,-1),m.splice(h,1)):c+=i[h];return c}(V,C,!0):function(r,t,e){if(0===r.length)return"";void 0===e&&(e=!0);void 0===t&&(t=!0);r=String(r);for(var i="",a=r.split(""),o=0;o<r.length;o++){var u=!1;if(a[o]>="ﹰ"&&a[o]<"\ufeff"){var f=r.charCodeAt(o);a[o]>="ﻵ"&&a[o]<="ﻼ"?(t?(o>0&&e&&" "===a[o-1]?i=i.substring(0,i.length-1)+"ل":(i+="ل",u=!0),i+=n.AlefTable[(f-65269)/2]):(i+=n.AlefTable[(f-65269)/2],i+="ل",o+1<r.length&&e&&" "===a[o+1]?o++:u=!0),u&&(g(p,o,!0,1),m.splice(o,0,m[o]))):i+=n.FETo06Table[f-65136]}else i+=a[o]}return i}(C,V,!0),this.sourceToTarget=m,this.targetToSource=p,this.levels=F,o},r.prototype._inputFormatSetter=function(r){if(!O.test(r))throw new Error("dojox/string/BidiEngine: the bidi layout string is wrong!");this.inputFormat=r},r.prototype._outputFormatSetter=function(r){if(!O.test(r))throw new Error("dojox/string/BidiEngine: the bidi layout string is wrong!");this.outputFormat=r},r.prototype.checkParameters=function(r,t){return r?this._inputFormatSetter(r):r=this.inputFormat,t?this._outputFormatSetter(t):t=this.outputFormat,r!==t},r.prototype.checkContextual=function(r){var t=i(r);if("ltr"!==t&&"rtl"!==t){try{t=document.dir.toLowerCase()}catch(r){}"ltr"!==t&&"rtl"!==t&&(t="ltr")}return t},r.prototype.hasBidiChar=function(r){return C.test(r)},r}();function i(r){var t=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(r);return t?t[0]<="z"?"ltr":"rtl":""}function a(r,t){var n=r.split(""),e=[];return o(n,e,t),function(r,t,n){if(0===n.hiLevel||n.swap.substr(0,1)===n.swap.substr(1,2))return;for(var e=0;e<r.length;e++)1===t[e]&&(r[e]=h(r[e]))}(n,e,t),A(2,n,e,t),A(1,n,e,t),F=e,n.join("")}function o(r,t,e){var i,a,o,u=r.length,f=e.dir?n.impTabRtl:n.impTabLtr,s=null,l=null,T=null,A=0,h=null,B=-1,U=null,L=null,v=[],_=[];for(e.hiLevel=e.dir,e.lastArabic=!1,e.hasUbatAl=!1,e.hasUbatB=!1,e.hasUbatS=!1,U=0;U<u;U++)v[U]=(i=r[U],a=void 0,o=void 0,a=i.charCodeAt(0),(o=n.MasterTable[a>>8])<n.TBBASE?o:n.UnicodeTable[o-n.TBBASE][255&a]);for(L=0;L<u;L++){if(s=A,_[L]=l=c(r,v,_,L,e),h=240&(A=f[s][l]),A&=15,t[L]=T=f[A][R],h>0)if(16===h){for(U=B;U<L;U++)t[U]=1;B=-1}else B=-1;if(f[A][S])-1===B&&(B=L);else if(B>-1){for(U=B;U<L;U++)t[U]=T;B=-1}v[L]===n.UBAT_B&&(t[L]=0),e.hiLevel|=T}e.hasUbatS&&function(r,t,e,i){for(var a=0;a<e;a++)if(r[a]===n.UBAT_S){t[a]=i.dir;for(var o=a-1;o>=0&&r[o]===n.UBAT_WS;o--)t[o]=i.dir}}(v,t,u,e)}function u(r,t){var n=r.split("");if(t){var e=[];o(n,e,t),F=e}return n.reverse(),m.reverse(),n.join("")}function f(r,t,n){for(var e=0;e<t;e++)if(r[e]===n)return e;return-1}function s(r){for(var t=0;t<n.ArabicAlefBetIntervalsBegine.length;t++)if(r>=n.ArabicAlefBetIntervalsBegine[t]&&r<=n.ArabicAlefBetIntervalsEnd[t])return!0;return!1}function l(r,t,n,e){for(;t*n<e&&v(r[t]);)t+=n;return!!(t*n<e&&s(r[t]))}function T(r,t,e,i){for(;t*e<i&&v(r[t]);)t+=e;var a=" ";if(!(t*e<i))return!1;a=r[t];for(var o=0;o<n.AlefTable.length;o++)if(n.AlefTable[o]===a)return!0;return!1}function A(r,t,n,e){if(!(e.hiLevel<r)){if(1===r&&e.dir===w&&!e.hasUbatB)return t.reverse(),void m.reverse();for(var i,a,o,u,f,s=t.length,l=0;l<s;){if(n[l]>=r){for(i=l+1;i<s&&n[i]>=r;)i++;for(a=l,o=i-1;a<o;a++,o--)u=t[a],t[a]=t[o],t[o]=u,f=m[a],m[a]=m[o],m[o]=f;l=i}l++}}}function c(r,t,e,i,a){var o=t[i];return{UBAT_L:function(){return a.lastArabic=!1,n.UBAT_L},UBAT_R:function(){return a.lastArabic=!1,n.UBAT_R},UBAT_ON:function(){return n.UBAT_ON},UBAT_AN:function(){return n.UBAT_AN},UBAT_EN:function(){return a.lastArabic?n.UBAT_AN:n.UBAT_EN},UBAT_AL:function(){return a.lastArabic=!0,a.hasUbatAl=!0,n.UBAT_R},UBAT_WS:function(){return n.UBAT_ON},UBAT_CS:function(){var r,o;return i<1||i+1>=t.length||(r=e[i-1])!==n.UBAT_EN&&r!==n.UBAT_AN||(o=t[i+1])!==n.UBAT_EN&&o!==n.UBAT_AN?n.UBAT_ON:(a.lastArabic&&(o=n.UBAT_AN),o===r?o:n.UBAT_ON)},UBAT_ES:function(){return(i>0?e[i-1]:n.UBAT_B)===n.UBAT_EN&&i+1<t.length&&t[i+1]===n.UBAT_EN?n.UBAT_EN:n.UBAT_ON},UBAT_ET:function(){if(i>0&&e[i-1]===n.UBAT_EN)return n.UBAT_EN;if(a.lastArabic)return n.UBAT_ON;for(var r=i+1,o=t.length;r<o&&t[r]===n.UBAT_ET;)r++;return r<o&&t[r]===n.UBAT_EN?n.UBAT_EN:n.UBAT_ON},UBAT_NSM:function(){if("VLTR"===a.inFormat){for(var o=t.length,u=i+1;u<o&&t[u]===n.UBAT_NSM;)u++;if(u<o){var f=r[i].charCodeAt[0],s=f>=1425&&f<=2303||64286===f,l=t[u];if(s&&(l===n.UBAT_R||l===n.UBAT_AL))return n.UBAT_R}}return i<1||t[i-1]===n.UBAT_B?n.UBAT_ON:e[i-1]},UBAT_B:function(){return a.lastArabic=!0,a.hasUbatB=!0,a.dir},UBAT_S:function(){return a.hasUbatS=!0,n.UBAT_ON},UBAT_LRE:function(){return a.lastArabic=!1,n.UBAT_ON},UBAT_RLE:function(){return a.lastArabic=!1,n.UBAT_ON},UBAT_LRO:function(){return a.lastArabic=!1,n.UBAT_ON},UBAT_RLO:function(){return a.lastArabic=!1,n.UBAT_ON},UBAT_PDF:function(){return a.lastArabic=!1,n.UBAT_ON},UBAT_BN:function(){return n.UBAT_ON}}[n.TYPES_NAMES[o]]()}function h(r){for(var t,e=0,i=n.SwapTable.length-1;e<=i;)if(t=Math.floor((e+i)/2),r<n.SwapTable[t][0])i=t-1;else{if(!(r>n.SwapTable[t][0]))return n.SwapTable[t][1];e=t+1}return r}function B(r){for(var t=0;t<n.StandAlonForm.length;t++)if(n.StandAlonForm[t]===r)return!0;return!1}function U(r){for(var t=0;t<n.BaseForm.length;t++)if(r===n.BaseForm[t])return n.MedialForm[t];return r}function L(r,t){for(var e=0;e<n.BaseForm.length;e++)if(r===n.BaseForm[e])return t[e];return r}function v(r){return r>="ً"&&r<="ٕ"}function _(r){return"L"===r?"LTR":"R"===r?"RTL":"C"===r?"CLR":"D"===r?"CRL":""}function b(r,t,n,e){for(;t*n<e&&v(r[t]);)t+=n;return t*n<e&&(r[t]=" ",!0)}function d(r,t){for(var e=0;e<n.AlefTable.length;e++)if(r===n.AlefTable[e])return t[e];return r}function g(r,t,n,e){for(var i=0;i<r.length;i++)(r[i]>t||!n&&r[i]===t)&&(r[i]+=e)}t.default=e;var m=[],p=[],F=[],N={dir:0,defInFormat:"LLTR",defoutFormat:"VLTR",defSwap:"YN",inFormat:"LLTR",outFormat:"VLTR",swap:"YN",hiLevel:0,lastArabic:!1,hasUbatAl:!1,hasBlockSep:!1,hasSegSep:!1,defOutFormat:""},R=5,S=6,E=0,w=1,O=/^[(I|V)][(L|R|C|D)][(Y|N)][(S|N)][N]$/,C=/[\u0591-\u06ff\ufb1d-\ufefc]/}));