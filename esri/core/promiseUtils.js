// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","@dojo/framework/shim/AbortController","dojo/Deferred","dojo/promise/all","./clock","./Error","./events","./has","./maybe","./Logger","@dojo/framework/shim/Promise"],(function(r,n,e,t,o,i,u,c,f,a,l){Object.defineProperty(n,"__esModule",{value:!0});var s=l.getLogger("esri");function v(r){return f("esri-native-promise")?Promise.all(r):o(r)}function h(r,n){if(f("esri-native-promise"))return new Promise((function(n,e){try{r(n,e)}catch(r){Promise.resolve().then((function(){return e(r)}))}}));var e=new t(n);try{r((function(r){return P(r).then(e.resolve)}),e.reject)}catch(r){e.reject(r)}return e.promise}function m(r){void 0===r&&(r="Aborted");var n=new u("AbortError",r);return n.dojoType="cancel",n}function p(){return new e.default}function b(r){if(w(r))throw m()}function d(r){return a.isSome(r)?"aborted"in r?r:r.signal:r}function w(r){var n=d(r);return a.isSome(n)&&n.aborted}function j(r,n){var e=d(r);if(!a.isNone(e)){if(!e.aborted)return c.once(e,"abort",(function(){return n()}));n()}}function y(r){return r&&("AbortError"===r.name||"cancel"===r.dojoType)}function A(r){var n=null,e=h((function(r,e){n={resolve:r,reject:e}}),r);return n.promise=e,n.cancel=function(){n.reject(m())},n}function g(r){if(r){if("function"!=typeof r.forEach){var n=Object.keys(r);return g(n.map((function(n){return r[n]}))).then((function(r){var e={};return n.forEach((function(n,t){return e[n]=r[t]})),e}))}var e=r,t=null,o=E;return h((function(r,n){var i=[],u=e.length;0===u&&r(i),e.forEach((function(e){var c={promise:e||o(e)};i.push(c),c.promise.then((function(r){c.value=r})).catch((function(r){c.error=r})).then((function(){0===--u&&(t?n(m()):r(i))}))}))}),(function(r){t=r||"Invocation cancellation",e.forEach((function(n){"cancel"in n&&n.cancel(r)}))}))}}function E(r){if(void 0===r&&(r=void 0),f("esri-native-promise"))return Promise.resolve(r);var n=new t;return n.resolve(r),n.promise}function T(r,n,e){void 0===n&&(n=void 0);var t=p();return j(e,(function(){return t.abort()})),h((function(e,o){var i=setTimeout((function(){i=0,e(n)}),r);j(t,(function(){i&&(clearTimeout(i),o(m()))}))}),(function(){return t.abort()}))}function P(r){return r&&"object"==typeof r&&"then"in r&&"function"==typeof r.then?r:E(r)}n.all=v,n.filter=function(r,n){var e=r.slice();return v(r.map((function(r,e){return n(r,e)}))).then((function(r){return e.filter((function(n,e){return r[e]}))}))},n.create=h,n.createAbortError=m,n.createAbortController=p,n.throwIfAborted=b,n.isAborted=w,n.throwIfAbortError=function(r){if(y(r))throw r},n.throwIfNotAbortError=function(r){if(!y(r))throw r},n.onAbort=j,n.onAbortOrThrow=function(r,n){var e=d(r);if(!a.isNone(e))return b(e),c.once(e,"abort",(function(){return n(m())}))},n.isAbortError=y,n.ignoreAbortErrors=function(r){return r.catch((function(r){if(!y(r))throw r}))},n.logOnError=function(r,n){return r.catch((function(r){y(r)||(n=a.isSome(n)?n:s).error(r)}))},n.createDeferred=A,n.eachAlways=g,n.isThenable=function(r){return r&&"function"==typeof r.then},n.eachAlwaysValues=function(r){return g(r).then((function(r){return r.filter((function(r){return!!r.value})).map((function(r){return r.value}))}))},n.first=function(r){return r&&r.length?h((function(n,e){for(var t=0,o=r;t<o.length;t++){o[t].then(n,e)}})):E()},n.reject=function(r){if(f("esri-native-promise"))return Promise.reject(r);var n=new t;return n.reject(r),n.promise},n.resolve=E,n.after=T,n.timeout=function(r,n,e,t){var o=e&&"abort"in e?e:null;null!=t||o||(t=e);var i=setTimeout((function(){i=0,o&&o.abort()}),n),c=function(){throw t||new u("promiseUtils:timeout","The wrapped promise did not resolve within "+n+" ms")};return r.then((function(r){if(0===i)throw c();return clearTimeout(i),r}),(function(r){throw clearTimeout(i),0===i?c():r}))},n.wrapCallback=function(r){var n=!1;return h((function(){r((function(r){n||E(r)}))}),(function(){return n=!0}))},n.isPromiseLike=function(r){return r&&"function"==typeof r.then},n.when=P,n.debounce=function(r,n){var e,t,o,i;void 0===n&&(n=-1);var u=null,c=function(){for(var f=[],a=0;a<arguments.length;a++)f[a]=arguments[a];if(e){t=f,i&&i.reject(m());var l=(i=A()).promise;if(u){var s=u;u=null,s.abort()}return l}if(o=i||A(),i=null,n>0){var v=p(),h=e=P(r.apply(void 0,f.concat([v.signal])));T(n).then((function(){e===h&&(i?v.abort():u=v)}))}else e=1,e=P(r.apply(void 0,f));var b=function(){var r=t;t=o=e=u=null,null!=r&&c.apply(void 0,r)},d=e,w=o;return d.then(b,b),d.then(w.resolve,w.reject),w.promise};return c},n.createResolver=function(r){var n,e,t=h((function(r,t){n=r,e=t}),r),o=function(r){n(r)};return o.resolve=function(r){return n(r)},o.reject=function(r){return e(r)},o.timeout=function(r,n){return i.default.setTimeout((function(){return o.reject(n)}),r)},o.promise=t,o},n.always=function(r,n){return r.then(n,n)}}));