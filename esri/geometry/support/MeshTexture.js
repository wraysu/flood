// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","@dojo/framework/shim/WeakMap","../../core/compilerUtils","../../core/JSONSupport","../../core/urlUtils","../../core/accessorSupport/decorators","../../core/accessorSupport/ensureType","../../views/support/screenshotUtils"],(function(t,e,r,a,n,o,i,s,p,l,u){var c=new n.default,d=0;return function(t){function e(e){var r=t.call(this,e)||this;return r.wrap="repeat",r}var n;return r(e,t),n=e,Object.defineProperty(e.prototype,"url",{get:function(){return this._get("url")||null},set:function(t){this._set("url",t),t&&this._set("data",null)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"data",{get:function(){return this._get("data")||null},set:function(t){this._set("data",t),t&&this._set("url",null)},enumerable:!0,configurable:!0}),e.prototype.writeData=function(t,e,r,a){if(t instanceof HTMLImageElement){var n={type:"image-element",src:s.toJSON(t.src,a),crossOrigin:t.crossOrigin};e[r]=n}else if(t instanceof HTMLCanvasElement){var o=t.getContext("2d").getImageData(0,0,t.width,t.height);n={type:"canvas-element",imageData:this.encodeImageData(o)};e[r]=n}else if(t instanceof HTMLVideoElement){n={type:"video-element",src:s.toJSON(t.src,a),autoplay:t.autoplay,loop:t.loop,muted:t.muted,crossOrigin:t.crossOrigin,preload:t.preload};e[r]=n}else{n={type:"image-data",imageData:this.encodeImageData(t)};e[r]=n}},e.prototype.readData=function(t){switch(t.type){case"image-element":var e=new Image;return e.src=t.src,e.crossOrigin=t.crossOrigin,e;case"canvas-element":var r=this.decodeImageData(t.imageData),a=document.createElement("canvas");return a.width=r.width,a.height=r.height,a.getContext("2d").putImageData(r,0,0),a;case"image-data":return this.decodeImageData(t.imageData);case"video-element":var n=document.createElement("video");return n.src=t.src,n.crossOrigin=t.crossOrigin,n.autoplay=t.autoplay,n.loop=t.loop,n.muted=t.muted,n.preload=t.preload,n;default:return void o.neverReached(t)}},Object.defineProperty(e.prototype,"transparent",{get:function(){var t=this.data,e=this.url;if(t instanceof HTMLCanvasElement)return this.imageDataContainsTransparent(t.getContext("2d").getImageData(0,0,t.width,t.height));if(t instanceof ImageData)return this.imageDataContainsTransparent(t);if(e){var r=e.substr(e.length-4,4).toLowerCase(),a=e.substr(0,15).toLocaleLowerCase();if(".png"===r||"data:image/png;"===a)return!0}return!1},set:function(t){null!=t?this._override("transparent",t):this._clearOverride("transparent")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentHash",{get:function(){var t=this,e="string"==typeof this.wrap?this.wrap:"object"==typeof this.wrap?this.wrap.horizontal+"/"+this.wrap.vertical:"",r=function(r){return void 0===r&&(r=""),"d:"+r+",t:"+t.transparent+",w:"+e};return null!=this.url?r(this.url):null!=this.data?this.data instanceof HTMLImageElement||this.data instanceof HTMLVideoElement?r(this.data.src):(c.has(this.data)||c.set(this.data,++d),r(c.get(this.data))):r()},enumerable:!0,configurable:!0}),e.prototype.clone=function(){return new n({url:this.url,data:this.data,wrap:this.cloneWrap()})},e.prototype.cloneWithDeduplication=function(t){var e=t.get(this);if(e)return e;var r=new n({url:this.url,data:this.data,wrap:this.cloneWrap()});return t.set(this,r),r},e.prototype.cloneWrap=function(){return"string"==typeof this.wrap?this.wrap:{horizontal:this.wrap.horizontal,vertical:this.wrap.vertical}},e.prototype.encodeImageData=function(t){for(var e="",r=0;r<t.data.length;r++)e+=String.fromCharCode(t.data[r]);return{data:btoa(e),width:t.width,height:t.height}},e.prototype.decodeImageData=function(t){for(var e=atob(t.data),r=new Uint8ClampedArray(e.length),a=0;a<e.length;a++)r[a]=e.charCodeAt(a);return u.wrapImageData(r,t.width,t.height)},e.prototype.imageDataContainsTransparent=function(t){for(var e=3;e<t.data.length;e+=4)if(255!==t.data[e])return!0;return!1},e.from=function(t){return"string"==typeof t?new n({url:t}):t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageData||t instanceof HTMLVideoElement?new n({data:t}):l.ensureClass(n,t)},a([p.property({type:String,json:{write:s.write}})],e.prototype,"url",null),a([p.property({json:{write:{overridePolicy:function(){return{enabled:!this.url}}}}}),p.property()],e.prototype,"data",null),a([p.writer("data")],e.prototype,"writeData",null),a([p.reader("data")],e.prototype,"readData",null),a([p.property({type:Boolean,dependsOn:["data","url"],json:{write:{overridePolicy:function(){return{enabled:this._isOverridden("transparent")}}}}})],e.prototype,"transparent",null),a([p.property({json:{write:!0}})],e.prototype,"wrap",void 0),a([p.property({readOnly:!0,dependsOn:["url","data","wrap","transparent"]})],e.prototype,"contentHash",null),e=n=a([p.subclass("esri.geometry.support.MeshTexture")],e)}(p.declared(i.JSONSupport))}));