// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/Error","../../core/urlUtils","../../geometry/Extent","../../geometry/SpatialReference"],(function(e,t,r,n,a,i){Object.defineProperty(t,"__esModule",{value:!0});var l,s=[[4001,4999],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3416,3416],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]],o={84:4326,83:4269,27:4267};function u(e){return s.some((function(t){var r=t[0],n=t[1];return e>=r&&e<=n}))}function f(e,t){var r=t&&t.getElementsByTagName(e);return r&&r.length>0?r[0]:null}function c(e,t,r){var n=f(e,t);return n?n.textContent:r}function p(e,t,r){if(!e)return null;var n,l,s,o,u=parseFloat(e.getAttribute("minx")),f=parseFloat(e.getAttribute("miny")),c=parseFloat(e.getAttribute("maxx")),p=parseFloat(e.getAttribute("maxy"));r?(n=isNaN(f)?-Number.MAX_VALUE:f,l=isNaN(u)?-Number.MAX_VALUE:u,s=isNaN(p)?Number.MAX_VALUE:p,o=isNaN(c)?Number.MAX_VALUE:c):(n=isNaN(u)?-Number.MAX_VALUE:u,l=isNaN(f)?-Number.MAX_VALUE:f,s=isNaN(c)?Number.MAX_VALUE:c,o=isNaN(p)?Number.MAX_VALUE:p);var m=new i({wkid:t});return new a({xmin:n,ymin:l,xmax:s,ymax:o,spatialReference:m})}function m(e,t){var r=f(t,e),a=f("DCPType",r);if(a){var i=f("HTTP",a);if(i){var l=f("Get",i);if(l){var s=function(e,t,r,n){var a=f(e,r);return a?a.getAttribute(t):n}("OnlineResource","xlink:href",l,null);if(s)return s.indexOf("&")===s.length-1&&(s=s.substring(0,s.length-1)),function(e,t){var r=[],a=n.urlToObject(e);for(var i in a.query)a.query.hasOwnProperty(i)&&-1===t.indexOf(i.toLowerCase())&&r.push(i+"="+a.query[i]);return a.path+(r.length?"?"+r.join("&"):"")}(s,["service","request"])}}}return null}function d(e,t){var r=e.getElementsByTagName("Operation");if(!r||!r.length){var n=f(t,e).getElementsByTagName("Format");return Array.prototype.slice.call(n).map((function(e){return e.textContent}))}var a=Array.prototype.slice.call(r),i=[];return a.forEach((function(e){if(e.getAttribute("name")===t){var r=e.getElementsByTagName("Format");Array.prototype.slice.call(r).forEach((function(e){i.push(e.textContent)}))}})),i}function x(e,t,r){var n=function(e,t){for(var r=0;r<t.childNodes.length;r++){var n=t.childNodes[r];if(n.nodeType===Node.ELEMENT_NODE&&n.nodeName===e)return n}return null}(t,e);if(!n)return r;var a=n.textContent;if(null==a||""===a)return r;var i=Number(a);return isNaN(i)?r:i}function y(e,t){if(!e)return null;var r={id:l++,fullExtents:[],parentLayerId:null,queryable:"1"===e.getAttribute("queryable"),spatialReferences:[],sublayers:null},n=f("LatLonBoundingBox",e),s=f("EX_GeographicBoundingBox",e),m=null;n&&(m=p(n,4326)),s&&((m=new a(0,0,0,0,new i({wkid:4326}))).xmin=parseFloat(c("westBoundLongitude",s,0)),m.ymin=parseFloat(c("southBoundLatitude",s,0)),m.xmax=parseFloat(c("eastBoundLongitude",s,0)),m.ymax=parseFloat(c("northBoundLatitude",s,0))),n||s||(m=new a(-180,-90,180,90,new i({wkid:4326}))),r.minScale=x(e,"MaxScaleDenominator",0),r.maxScale=x(e,"MinScaleDenominator",0);var d=["1.0.0","1.1.0","1.1.1"].indexOf(t)>-1?"SRS":"CRS";return Array.prototype.slice.call(e.childNodes).forEach((function(e){if("Name"===e.nodeName)r.name=e.textContent||"";else if("Title"===e.nodeName)r.title=e.textContent||"";else if("Abstract"===e.nodeName)r.description=e.textContent||"";else if("BoundingBox"===e.nodeName){var n=e.getAttribute(d);if(n&&0===n.indexOf("EPSG:"))0===(i=parseInt(n.substring(5),10))||isNaN(i)||m||(m="1.3.0"===t?p(e,i,u(i)):p(e,i));var a=n&&n.indexOf(":");if(a&&a>-1){var i;0===(i=parseInt(n.substring(a+1,n.length),10))||isNaN(i)||(i=o[i]?o[i]:i);var l="1.3.0"===t?p(e,i,u(i)):p(e,i);r.fullExtents.push(l)}}else if(e.nodeName===d){e.textContent.split(" ").forEach((function(e){0===(e=e.indexOf(":")>-1?parseInt(e.split(":")[1],10):parseInt(e,10))||isNaN(e)||(o[e]&&(e=o[e]),-1===r.spatialReferences.indexOf(e)&&r.spatialReferences.push(e))}))}else if("Style"!==e.nodeName||r.legendURL){if("Layer"===e.nodeName){var s=y(e,t);s&&(s.parentLayerId=r.id,r.sublayers||(r.sublayers=[]),r.sublayers.push(s))}}else{var c=f("LegendURL",e);if(c){var x=f("OnlineResource",c);x&&(r.legendURL=x.getAttribute("xlink:href"))}}})),r.extent=m&&m.toJSON(),r}t.parseCapabilities=function(e){if(e){if(l=-1,"string"==typeof e)e=(new DOMParser).parseFromString(e,"text/xml");var t=e.documentElement;if("ServiceExceptionReport"===t.nodeName){var n=Array.prototype.slice.call(t.childNodes).map((function(e){return e.textContent})).join("\r\n");throw new r("wmslayer:wms-capabilities-xml-is-not-valid","The server returned errors when the WMS capabilities were requested.",n)}var i=f("Layer",t);if(i){var s,o,u,p,x="WMS_Capabilities"===t.nodeName||"WMT_MS_Capabilities"===t.nodeName?t.getAttribute("version"):"1.3.0",N=f("Service",t),h=c("Title",N,"")||c("Name",N,""),g=c("AccessConstraints",N,""),v=c("Abstract",N,""),b=parseInt(c("MaxWidth",N,5e3),10),E=parseInt(c("MaxHeight",N,5e3),10),A=f("Capability",t),L=d(t,"GetMap"),S=m(t,"GetMap"),M=y(i,x),w=0;if(Array.prototype.slice.call(A.childNodes).forEach((function(e){"Layer"===e.nodeName&&(0===w?s=e:1===w?(M.name&&(M.name="",M.sublayers.push(y(s,x))),M.sublayers.push(y(e,x))):M.sublayers.push(y(e,x)),w++)})),!M)return null;var O=M.fullExtents;if((o=M.sublayers)||(o=[]),0===o.length&&o.push(M),!(u=M.extent)){var R=new a(o[0].extent);M.extent=R.toJSON(),u=M.extent}if(!(p=M.spatialReferences).length&&o.length>0){var C=function(e){var t=[];return e.sublayers.forEach((function(e){!t.length&&e.spatialReferences.length&&(t=e.spatialReferences||C(e))})),t};o.forEach((function(e){p.length||(p=e.spatialReferences||C(e))}))}var F,I=m(t,"GetFeatureInfo");if(I){var T=d(t,"GetFeatureInfo");T.indexOf("text/html")>-1?F="text/html":T.indexOf("text/plain")>-1&&(F="text/plain")}if(!F){var _=function(e){e&&(e.queryable=!1,e.sublayers&&e.sublayers.forEach((function(e){_(e)})))};_(M)}var B=function e(t){var r=[];return t.forEach((function(t){r.push(t),t.sublayers&&t.sublayers.length&&(r=r.concat(e(t.sublayers)),delete t.sublayers)})),r}(o),U=M.minScale||0;return{copyright:g,description:v,extent:u,fullExtents:O,featureInfoFormat:F,featureInfoUrl:I,mapUrl:S,maxImageWidth:b,maxImageHeight:E,maxScale:M.maxScale||0,minScale:U,layers:B,spatialReferences:p,supportedImageFormatTypes:L,title:h,version:x}}}},t.coordsReversed=u,t.getPopupLayers=function(e){return e.length?e.filter((function(e){return e.popupEnabled&&e.name&&e.queryable})).map((function(e){return e.name})).join(","):""}}));