// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/declareExtendsHelper","../../../geometry","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators","../PixelBlock","../RasterInfo","../RasterStorageInfo","./BaseRaster","./xmlUtilities"],(function(e,t,r,n,o,a,i,s,l,p,u,f,c,h,g,d){var m,y,w=(m=new ArrayBuffer(4),y=new Uint8Array(m),new Uint32Array(m)[0]=1,1===y[0]),I=new Map;I.set("Int8","s8"),I.set("UInt8","u8"),I.set("Int16","s16"),I.set("UInt16","u16"),I.set("Int32","s32"),I.set("UInt32","u32"),I.set("Float32","f32"),I.set("Float64","f32"),I.set("Double64","f32");var x=new Map;return x.set("lerc",".lrc"),x.set("none",".til"),x.set("deflate",".pzp"),x.set("jpeg",".jzp"),function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._files=null,t._storageIndex=null,t}return a(t,e),t.prototype.open=function(e){return o(this,void 0,void 0,(function(){var t,n,o,a,i,s,p,u,f,c,h,g,d,m,y,w,I,x,b,v,A;return r(this,(function(r){switch(r.label){case 0:return[4,this.init()];case 1:return r.sent(),this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),t=e?l.unwrap(e.signal):null,[4,this.request({url:this.url,responseType:"xml"},t)];case 2:return n=r.sent(),o=this._parseHeader(n),a=o.rasterInfo,i=o.files,this._set("rasterInfo",a),this._files=i,[4,this.request({url:i.index,responseType:"array-buffer"},t)];case 3:for(s=r.sent(),this._storageIndex=this._parseIndex(s),p=0,u=-1,h=this.rasterInfo.storageInfo,g=h.blockWidth,d=h.blockHeight,m=h.compression,y=this.rasterInfo.storageInfo.pyramidScalingFactor,w=this.rasterInfo,I=w.width,x=w.height,b=w.bandCount,v=[],A="none"===m?1:b;p<this._storageIndex.length;)u++,f=Math.ceil(I/g/Math.pow(y,u)),c=Math.ceil(x/d/Math.pow(y,u)),p+=f*c*A*4,v.push({maxRow:c,maxCol:f,minCol:0,minRow:0});return this.rasterInfo.storageInfo.blockBoundary=v,u>0&&(this.rasterInfo.storageInfo.firstPyramidLevel=1,this.rasterInfo.storageInfo.maximumPyramidLevel=u),[2]}}))}))},t.prototype.fetchRawTile=function(e,t,n,a){return void 0===a&&(a={}),o(this,void 0,void 0,(function(){var o,i,s,l,u,c,h,g,d,m,y,w,I,x,b,v,A,M,R,_,E,T,F,k,S,U;return r(this,(function(r){switch(r.label){case 0:if(o=this.rasterInfo.storageInfo,i=o.blockWidth,s=o.blockHeight,l=o.blockBoundary,u=o.compression,!(c=l[e])||c.maxRow<t||c.maxCol<n||c.minRow>t||c.minCol>n)return[2,null];if(h=this.rasterInfo,g=h.bandCount,d=h.pixelType,m=this._getTileLocation(e,t,n),y=m.ranges,w=m.actualTileWidth,I=m.actualTileHeight,!y||0===y.length)return[2,null];if(0===y[0].from&&0===y[0].to)return U=new Uint8Array(i*s),[2,new f({width:i,height:s,pixels:null,mask:U,validPixelCount:0})];for(x=this.ioConfig.bandIds,b="none"===u?1:g,v=[],A=0,A=0;A<b;A++)(!x||x.indexOf[A]>-1)&&v.push(this.request({url:this._files.data,range:{from:y[A].from,to:y[A].to},responseType:"array-buffer"},a.signal));return[4,p.all(v)];case 1:for(M=r.sent(),R=M.map((function(e){return e.byteLength})).reduce((function(e,t){return e+t})),_=new Uint8Array(R),E=0,A=0;A<b;A++)_.set(new Uint8Array(M[A]),E),E+=M[A].byteLength;return T="lerc"===this.rasterInfo.storageInfo.compression?"lerc":"bip",[4,this.decodePixelBlock(_.buffer,{width:i,height:s,format:T,pixelType:d})];case 2:if(F=r.sent(),k=0,S=0,w!==i||I!==s)if(U=F.mask)for(A=0;A<s;A++)if(S=A*i,A<I)for(k=w;k<i;k++)U[S+k]=0;else for(k=0;k<i;k++)U[S+k]=0;else for(U=new Uint8Array(i*s),F.mask=U,A=0;A<I;A++)for(S=A*i,k=0;k<w;k++)U[S+k]=1;return[2,F]}}))}))},t.prototype._parseIndex=function(e){if(e.byteLength%16>0)throw"invalid array buffer must be multiples of 16";var t,r,n,o,a,i;if(w){for(r=new Uint8Array(e),o=new ArrayBuffer(e.byteLength),n=new Uint8Array(o),a=0;a<e.byteLength/4;a++)for(i=0;i<4;i++)n[4*a+i]=r[4*a+3-i];t=new Uint32Array(o)}else t=new Uint32Array(e);return t},t.prototype._getTileLocation=function(e,t,r){var n,o,a,i=this.rasterInfo.storageInfo,s=i.blockWidth,l=i.blockHeight,p=i.pyramidScalingFactor,u=i.compression,f=this.rasterInfo,c=f.width,h=f.height,g=f.bandCount,d="none"===u?1:g,m=0,y=0;for(a=0;a<e;a++)y=Math.pow(p,a),m+=(n=Math.ceil(c/s/y))*(o=Math.ceil(h/l/y));y=Math.pow(p,e),n=Math.ceil(c/s/y),o=Math.ceil(h/l/y),m+=t*n+r,m*=4*d;for(var w=this._storageIndex.subarray(m,m+4*d),I=0,x=0,b=[],v=0;v<d;v++)x=(I=w[4*v+0]*Math.pow(2,32)+w[4*v+1])+w[4*v+2]*Math.pow(2,32)+w[4*v+3],b.push({from:I,to:x});return{ranges:b,actualTileWidth:r<n-1?s:Math.ceil(c/y)-s*(n-1),actualTileHeight:t<o-1?l:Math.ceil(h/y)-l*(o-1)}},t.prototype._parseHeader=function(e){var t=d.getElement(e,"MRF_META/Raster");if(!t)throw new s("mrf:open","not a valid MRF format");var r=d.getElement(t,"Size"),n=parseInt(r.getAttribute("x"),10),o=parseInt(r.getAttribute("y"),10),a=parseInt(r.getAttribute("c"),10),l=(d.getElementValue(t,"Compression")||"none").toLowerCase();if(!l||-1===["none","lerc"].indexOf(l))throw new s("mrf:open","currently does not support compression "+l);var p=d.getElementValue(t,"DataType")||"UInt8",u=I.get(p);if(null==u)throw new s("mrf:open","currently does not support pixel type "+p);var f,g,m=d.getElement(t,"PageSize"),y=parseInt(m.getAttribute("x"),10),w=parseInt(m.getAttribute("y"),10),b=d.getElement(t,"DataValues");if(b&&null!=(g=b.getAttribute("NoData"))&&(f=g.trim().split(" ").map((function(e){return parseFloat(e)}))),d.getElement(e,"MRF_META/CachedSource"))throw new s("mrf:open","currently does not support MRF referencing other data files");var v=d.getElement(e,"MRF_META/GeoTags"),A=d.getElement(v,"BoundingBox");if(null==A)throw new s("mrf:open","missing node MRF_META/GeoTags/BoundingBox");var M,R=parseFloat(A.getAttribute("minx")),_=parseFloat(A.getAttribute("miny")),E=parseFloat(A.getAttribute("maxx")),T=parseFloat(A.getAttribute("maxy")),F=d.getElementValue(v,"Projection"),k=d.getElementValue(e,"datafile"),S=d.getElementValue(e,"IndexFile");"LOCAL_CS[]"!==F&&(M=new i.SpatialReference({wkt:F}));var U=new i.Extent(R,_,E,T);U.spatialReference=M;var C=d.getElement(e,"MRF_META/Rsets"),B=parseInt(C&&C.getAttribute("scale")||"2",10),H=new h({origin:new i.Point({x:U.xmin,y:U.ymax,spatialReference:M}),blockWidth:y,blockHeight:w,pyramidBlockWidth:y,pyramidBlockHeight:w,compression:l,pyramidScalingFactor:B}),L=new i.Point({x:(E-R)/n,y:(T-_)/o,spatialReference:M});return{rasterInfo:new c({width:n,height:o,extent:U,spatialReference:M,bandCount:a,pixelType:u,pixelSize:L,noDataValue:f,storageInfo:H}),files:{mrf:this.url,index:S||this.url.replace(".mrf",".idx"),data:k||this.url.replace(".mrf",x.get(l))}}},n([u.property()],t.prototype,"_files",void 0),n([u.property()],t.prototype,"_storageIndex",void 0),n([u.property({type:String,json:{write:!0}})],t.prototype,"datasetFormat",void 0),t=n([u.subclass("esri.layers.support.rasterIO.MRFRaster")],t)}(u.declared(g))}));