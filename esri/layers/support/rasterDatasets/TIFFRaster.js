// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/assignHelper","../../../geometry","../../../core/Error","../../../core/maybe","../../../core/accessorSupport/decorators","../RasterInfo","../RasterStorageInfo","./BaseRaster","../rasterFormats/TiffDecoder","../rasterFormats/TiffTags"],(function(e,t,r,i,n,s,a,o,l,u,f,p,h,d,c,y){var m=function(e,t){var r=e.get(t);return r&&r.values},I=function(e,t){var r=e.get(t);return r&&r.values[0]};return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._files=null,t._headerInfo=null,t._bufferSize=1048576,t}return s(t,e),t.prototype.open=function(e){return n(this,void 0,void 0,(function(){var t,i,n,s,f,d,y,m,I,g,v,T,b,S,x,F,E,w,_,B,D,k,H,R,L,O,z;return r(this,(function(r){switch(r.label){case 0:return[4,this.init()];case 1:return r.sent(),t=e?u.unwrap(e.signal):null,[4,this.request({url:this.url,range:{from:0,to:this._bufferSize},responseType:"array-buffer"},t)];case 2:if(!(i=r.sent()))throw new l("tiffraster:open","failed to open url "+this.url);return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),n=c.parseSignature(i),s=n.littleEndian,f=n.firstIFD,d=[],[4,this.readIFDs(d,i,s,f,0,4,t)];case 3:if(r.sent(),y=c.getImageInfo(d),m=y.width,I=y.height,g=y.tileWidth,v=y.tileHeight,T=y.planes,b=y.pixelType,S=y.compression,x=y.firstPyramidLevel,F=y.maximumPyramidLevel,E=y.pyramidBlockWidth,w=y.pyramidBlockHeight,_=y.tileBoundary,B=y.metadata,D=o.Extent.fromJSON(y.extent),k=D.spatialReference,H=D?new o.Point({x:D.xmin,y:D.ymax,spatialReference:k}):new o.Point({x:0,y:0}),R=new h({blockWidth:g,blockHeight:v,pyramidBlockWidth:E,pyramidBlockHeight:w,compression:S,origin:H,firstPyramidLevel:x,maximumPyramidLevel:F,blockBoundary:_}),L=new o.Point({x:(D.xmax-D.xmin)/m,y:(D.ymax-D.ymin)/I,spatialReference:k}),O=B?{BandProperties:B.bandProperties,DataType:B.dataType}:null,z=new p({width:m,height:I,bandCount:T,pixelType:b,compression:S,pixelSize:L,storageInfo:R,spatialReference:k,keyProperties:O,extent:D,statistics:B?B.statistics:null}),this._set("rasterInfo",z),this._headerInfo=a({littleEndian:s,ifds:d},y),!this._headerInfo.isSupported)throw new l("tiffraster:open","this tiff is not supported: "+this._headerInfo.message);return[2]}}))}))},t.prototype.fetchRawTile=function(e,t,i,s){return void 0===s&&(s={}),n(this,void 0,void 0,(function(){var n,a,o,l,u,f,p,h,d,c,y,m,I,g,v;return r(this,(function(r){switch(r.label){case 0:return!this._headerInfo&&this._headerInfo.isSupported?[2,null]:(n=this.rasterInfo.storageInfo.blockBoundary,a=e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,o=e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight,!(l=n[e])||l.maxRow<t||l.maxCol<i||l.minRow>t||l.minCol>i?[2,null]:(u=this.getTileLocation(e,t,i))?(f=u.range,p=u.actualTileWidth,h=u.actualTileHeight,d=u.ifd,[4,this.request({url:this.url,range:f,responseType:"array-buffer"},s.signal)]):[2,null]);case 1:return c=r.sent(),[4,this.decodePixelBlock(c,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:d,offset:0,size:0},width:a,height:o,planes:null,pixelType:null})];case 2:if(y=r.sent(),p!==a||h!==o)if(v=y.mask)for(m=0;m<o;m++)if(g=m*a,m<h)for(I=p;I<a;I++)v[g+I]=0;else for(I=0;I<a;I++)v[g+I]=0;else for(v=new Uint8Array(a*o),y.mask=v,m=0;m<h;m++)for(g=m*a,I=0;I<p;I++)v[g+I]=1;return[2,y]}}))}))},t.prototype.readIFDs=function(e,t,i,s,a,o,l){return void 0===o&&(o=4),n(this,void 0,void 0,(function(){var n;return r(this,(function(r){switch(r.label){case 0:return s?s>=t.byteLength||s<0?[4,this.request({url:this.url,range:{from:s+a,to:s+a+this._bufferSize},responseType:"array-buffer"},l)]:[3,2]:[2,null];case 1:t=r.sent(),a=s+a,s=0,r.label=2;case 2:return[4,this.readIFD(t,i,s,a,y.TIFF_TAGS,o,l)];case 3:return n=r.sent(),e.push(n.ifd),n.nextIFD?[4,this.readIFDs(e,t,i,n.nextIFD-a,a,o,l)]:[2,null];case 4:return r.sent(),[2]}}))}))},t.prototype.readIFD=function(e,t,i,s,a,o,l){return void 0===a&&(a=y.TIFF_TAGS),void 0===o&&(o=4),n(this,void 0,void 0,(function(){var n,u,f,p,h,d,m,I;return r(this,(function(r){switch(r.label){case 0:return e?(n=c.parseIFD(e,t,i,s,a,o)).success?(u=[],n.ifd.forEach((function(e){e.values||u.push(e)})),u.length>0?(f=u.map((function(e){return e.offlineOffsetSize})),p=Math.min.apply(null,f.map((function(e){return e[0]}))),Math.min.apply(null,f.map((function(e){return e[0]+e[1]})))-p<=this._bufferSize?[4,this.request({url:this.url,range:{from:p,to:p+this._bufferSize},responseType:"array-buffer"},l)]:[3,2]):[3,2]):[3,5]:[2,null];case 1:e=r.sent(),s=p,u.forEach((function(r){return c.parseFieldValues(e,t,r,s)})),r.label=2;case 2:return n.ifd.has("GEOKEYDIRECTORY")?(h=n.ifd.get("GEOKEYDIRECTORY"),(d=h.values)&&d.length>4?(m=d[0]+"."+d[1]+"."+d[2],[4,this.readIFD(e,t,h.valueOffset+6-s,s,y.GEO_KEYS,2,l)]):[3,4]):[3,4];case 3:I=r.sent(),h.data=I.ifd,h.data&&h.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[m]}),r.label=4;case 4:return[2,n];case 5:return n.requiredBufferSize&&n.requiredBufferSize!==e.byteLength?[4,this.request({url:this.url,range:{from:s,to:s+n.requiredBufferSize+4},responseType:"array-buffer"},l)]:[3,7];case 6:return(e=r.sent()).byteLength<n.requiredBufferSize?[2,null]:[2,this.readIFD(e,t,0,s,y.TIFF_TAGS,4,l)];case 7:return[2]}}))}))},t.prototype.getTileLocation=function(e,t,r){var i=this.rasterInfo.storageInfo,n=i.firstPyramidLevel,s=i.blockBoundary,a=0===e?0:e-(n-1),o=this._headerInfo.ifds[a];if(!o)return null;var l=m(o,"TILEOFFSETS");if(void 0===l)return null;var u=m(o,"TILEBYTECOUNTS"),f=s[a],p=f.minRow,h=f.minCol,d=f.maxRow,c=f.maxCol;if(t>d||r>c||t<p||r<h)return null;var y=I(o,"IMAGEWIDTH"),g=I(o,"IMAGELENGTH"),v=I(o,"TILEWIDTH"),T=I(o,"TILELENGTH"),b=t*(c+1)+r,S=l[b],x=u[b];return null==S||null==x?null:{range:{from:S,to:S+x-1},ifd:o,actualTileWidth:r===c?y%v:v,actualTileHeight:t===d?g%T:T}},i([f.property()],t.prototype,"_files",void 0),i([f.property()],t.prototype,"_headerInfo",void 0),i([f.property()],t.prototype,"_bufferSize",void 0),i([f.property({type:String,json:{write:!0}})],t.prototype,"datasetFormat",void 0),t=i([f.subclass("esri.layers.support.rasterDatasets.TIFFRaster")],t)}(f.declared(d))}));