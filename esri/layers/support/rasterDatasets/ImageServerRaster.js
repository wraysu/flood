// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/assignHelper","../../../geometry","../../../request","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../core/urlUtils","../../../core/accessorSupport/decorators","../RasterInfo","../RasterStorageInfo","../TileInfo","../TilemapCache","./BaseRaster","../rasterFunctions/pixelUtils","../../../tasks/support/FeatureSet"],(function(e,t,i,n,r,a,l,s,o,u,c,h,p,m,f,x,d,y,v,g,S){return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._levelOffset=0,t._slices=null,t._tilemapCache=null,t.sourceJSON=null,t}return a(t,e),t.prototype.open=function(e){return r(this,void 0,void 0,(function(){var t,n,r,a,l,s,h,m,f,v,g,S,w,b,M,I,T,R,C,z,O,N,_,j,L;return i(this,(function(i){switch(i.label){case 0:return[4,this.init()];case 1:return i.sent(),t=e&&e.signal,this.sourceJSON?(r={data:this.sourceJSON},[3,4]):[3,2];case 2:return[4,o(this.url,{responseType:"json",query:{f:"json"},signal:t})];case 3:r=i.sent(),i.label=4;case 4:if((n=r).ssl&&(this.url=this.url.replace(/^http:/i,"https:")),a=n.data,this.sourceJSON=a,l=["jpg","jpeg","png","png8","png24","png32","mixed"],this.tileType=a.cacheType,null===this.tileType&&(l.indexOf(a.tileInfo.format.toLowerCase())>-1?this.tileType="Map":"lerc"===a.tileInfo.format.toLowerCase()?this.tileType="Elevation":this.tileType="Raster"),!a||!a.tileInfo)throw new u("imageserverraster:open","cannot initialize tiled image service");return this.datasetName=a.name,[4,this._fetchRasterInfo({signal:t})];case 5:if(s=i.sent(),!c.isSome(s))throw new u("image-server-raster:open","cannot initialize image service");if(h=d.fromJSON(a.tileInfo),m=s.extent,f=s.pixelSize,v=.5/s.width*f.x,g=void 0,S=void 0,w=h.lodAt(Math.max.apply(null,h.lods.map((function(e){return e.level})))),0!==a.maxScale&&("Raster"===this.tileType?(g=h.lods.filter((function(e){return e.resolution===f.x}))[0])||(g=h.lods.filter((function(e){return e.resolution>f.x})).sort((function(e,t){return e.resolution>t.resolution?1:-1}))[0]):(g=h.lods.filter((function(e){return Math.abs(e.scale-a.maxScale)<v}))[0])||(g=h.lods.filter((function(e){return e.scale>a.maxScale})).sort((function(e,t){return e.scale>t.scale?1:-1}))[0]),f.x=f.y=g.resolution,s.width=Math.ceil((m.xmax-m.xmin)/f.x-.1),s.height=Math.ceil((m.ymax-m.ymin)/f.y-.1)),g||(g=w),b=h.lodAt(Math.min.apply(null,h.lods.map((function(e){return e.level})))),0!==a.minScale&&"Raster"!==this.tileType&&(S=h.lods.filter((function(e){return Math.abs(e.scale-a.minScale)<v}))[0],this._levelOffset=S.level-b.level),S||(S=b),M=Math.max(f.x,f.y),(Math.abs(f.x-f.y)>v||!h.lods.some((function(e){return Math.abs(e.resolution-M)<v})))&&(f.x=f.y=g.resolution,s.width=Math.ceil((m.xmax-m.xmin)/f.x-.1),s.height=Math.ceil((m.ymax-m.ymin)/f.y-.1)),I=g.level-S.level,T=h.size,R=T[0],C=T[1],z=h.origin,O=f.x,N=f.y,_=[{minCol:Math.floor((m.xmin-z.x+.1*O)/R/O),maxCol:Math.floor((m.xmax-z.x-.1*O)/R/O),minRow:Math.floor((z.y-m.ymax+.1*N)/C/N),maxRow:Math.floor((z.y-m.ymin-.1*N)/C/N)}],I>0)for(j=0;j<I;j++)O*=2,N*=2,_.push({minCol:Math.floor((m.xmin-z.x+.1*O)/R/O),maxCol:Math.floor((m.xmax-z.x-.1*O)/R/O),minRow:Math.floor((z.y-m.ymax+.1*N)/C/O),maxRow:Math.floor((z.y-m.ymin-.1*N)/C/O)});return s.storageInfo=new x({blockWidth:h.size[0],blockHeight:h.size[1],pyramidBlockWidth:h.size[0],pyramidBlockHeight:h.size[1],compression:h.format,origin:h.origin,firstPyramidLevel:1,maximumPyramidLevel:I,tileInfo:h,blockBoundary:_}),this._set("rasterInfo",s),a.capabilities.toLowerCase().indexOf("tilemap")>-1&&(L={tileInfo:s.storageInfo.tileInfo,parsedUrl:p.urlToObject(this.url),url:this.url,tileServers:[],type:"tile"},this._tilemapCache=new y.TilemapCache({layer:L})),[2]}}))}))},t.prototype.fetchRawTile=function(e,t,n,a){return void 0===a&&(a={}),r(this,void 0,void 0,(function(){var r,l,s,o,u,c,h,p,m,f,x,d,y,v,S,w,b,M,I,T,R,C;return i(this,(function(i){switch(i.label){case 0:return r=this.rasterInfo,l=r.storageInfo,s=r.extent,o=r.pixelSize,u=l.maximumPyramidLevel-e+this._levelOffset,c=this.url+"/tile/"+u+"/"+t+"/"+n,h=this._slices?{sliceId:a.sliceId||0}:null,[4,this.request({url:c,query:h,responseType:"array-buffer"},a.signal)];case 1:return(p=i.sent())?[4,this.decodePixelBlock(p,{width:l.tileInfo.size[0],height:l.tileInfo.size[1],planes:null,pixelType:null,isPoint:"Elevation"===this.tileType})]:[2,null];case 2:return m=i.sent(),f=l.blockBoundary[e],"jpg"!==l.compression||n>f.minCol&&n<f.maxCol&&t>f.minRow&&t<f.maxRow?[2,m]:(x=l.origin,d=l.blockWidth,y=l.blockHeight,v=Math.pow(2,e),S=Math.round((s.xmin-x.x)/(o.x*v))%d,w=Math.round((s.xmax-x.x)/(o.x*v))%d,b=Math.round((x.y-s.ymax)/(o.x*v))%y,M=Math.round((x.y-s.ymin)/(o.x*v))%y,I=n===f.minCol?S:0,T=t===f.minRow?b:0,R=n===f.maxCol?w:d,C=t===f.maxRow?M:y,g.setValidBoundary(m,{x:I,y:T},{width:R-I,height:C-T}),[2,m])}}))}))},t.prototype.getSliceIndex=function(e){for(var t=e,i=0;i<this._slices.length;i++){var n=this._slices[i].multidimensionalDefinition;if(n.length===t.length&&!n.some((function(e){var i=t.filter((function(t){return e.variableName===t.variableName&&t.dimensionName===e.dimensionName}))[0];return i?(Array.isArray(e.values[0])?e.values[0][0]:e.values[0])!==(Array.isArray(i.values[0])?i.values[0][0]:i.values[0]):null})))return i}return null},t.prototype.computeBestPyramidLevelForLocation=function(e,t){return void 0===t&&(t={}),r(this,void 0,void 0,(function(){var n,r,a,l,s;return i(this,(function(i){switch(i.label){case 0:if(!this._tilemapCache)return[2,0];if(null===(n=this.identifyPixelLocation(e,0,t.datumTransformation)))return[2,null];r=0,a=this.rasterInfo.storageInfo.maximumPyramidLevel,l=a-r+this._levelOffset,s=n.srcLocation,i.label=1;case 1:if(!(l>=0))return[3,6];i.label=2;case 2:return i.trys.push([2,4,,5]),[4,this._tilemapCache.fetchAvailability(l,n.row,n.col,t)];case 3:return"available"===i.sent()?[3,6]:[3,5];case 4:return i.sent(),[3,5];case 5:return l--,r++,null===(n=this.identifyPixelLocation(s,r,t.datumTransformation))?[2,null]:[3,1];case 6:return-1===l||null==n?[2,null]:[2,r]}}))}))},t.prototype._fetchRasterInfo=function(e){return r(this,void 0,void 0,(function(){var t,n,r,a,l,u,c,p,m,x,d,y,v=this;return i(this,(function(i){return t=this.sourceJSON,n=Math.ceil((t.extent.xmax-t.extent.xmin)/t.pixelSizeX-.1),r=Math.ceil((t.extent.ymax-t.extent.ymin)/t.pixelSizeY-.1),a=s.SpatialReference.fromJSON(t.spatialReference||t.extent.spatialReference),"Map"===this.tileType?[2,new f({width:n,height:r,bandCount:3,extent:s.Extent.fromJSON(t.extent),spatialReference:a,pixelSize:new s.Point({x:t.pixelSizeX,y:t.pixelSizeY,spatialReference:a}),pixelType:"u8",statistics:null})]:(l=e.slice,u=e.signal,c=!!t.hasRasterAttributeTable&&o(this.url+"/rasterAttributeTable",{query:{slice:l,f:"json"},signal:u}).then((function(e){return S.fromJSON(e.data)})).catch((function(){return null})),p=!!t.hasColormap&&o(this.url+"/colormap",{query:{slice:l,f:"json"},signal:u}).then((function(e){return e.data&&e.data.colormap})),m=!!t.hasHistograms&&o(this.url+"/histograms",{query:{slice:l,f:"json"},signal:u}).then((function(e){return e.data&&e.data.histograms})),x=o(this.url+"/keyProperties",{query:{f:"json"},signal:u}).then((function(e){return e.data})).catch((function(){})),d=!!t.hasMultidimensions&&o(this.url+"/multidimensionalInfo",{query:{f:"json"},signal:u}).then((function(e){return e.data&&e.data.multidimensionalInfo})),y=!!t.hasMultidimensions&&o(this.url+"/slices",{query:{f:"json"},signal:u}).then((function(e){return e.data&&e.data.slices})).catch((function(){})),[2,h.all([c,p,m,x,d,y]).then((function(e){var i=null;if(t.minValues&&t.minValues.length===t.bandCount){i=[];for(var l=0;l<t.minValues.length;l++)i.push({min:t.minValues[l],max:t.maxValues[l],avg:t.meanValues[l],stddev:t.stdvValues[l]})}return v._slices=e[5]||null,new f({width:n,height:r,bandCount:t.bandCount,extent:s.Extent.fromJSON(t.extent),spatialReference:a,pixelSize:new s.Point({x:t.pixelSizeX,y:t.pixelSizeY,spatialReference:a}),pixelType:t.pixelType.toLowerCase(),statistics:i,attributeTable:e[0]||null,colormap:e[1]||null,histograms:e[2]||null,keyProperties:e[3]||null,multidimensionalInfo:e[4]||null})}))])}))}))},n([m.property({type:String,json:{write:!0}})],t.prototype,"datasetFormat",void 0),n([m.property()],t.prototype,"sourceJSON",void 0),n([m.property()],t.prototype,"tileType",void 0),t=n([m.subclass("esri.layers.support.rasterDatasets.ImageServerRaster")],t)}(m.declared(v))}));