// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/assignHelper","../../../geometry","../../../request","../../../core/Error","../../../core/JSONSupport","../../../core/maybe","../../../core/Promise","../../../core/promiseUtils","../../../core/urlUtils","../../../core/accessorSupport/decorators","../commonProperties","../TileInfo","./RawBlockCache","../rasterFormats/RasterCodec","../rasterFunctions/pixelUtils","../rasterFunctions/rasterProjectionHelper"],(function(e,t,r,o,n,i,a,s,l,u,c,f,p,h,m,d,y,x,v,g,w,b){return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.rasterJobHandler=null,t.datasetName=null,t.datasetFormat=null,t.rasterInfo=null,t.ioConfig={bandIds:null,sampling:"closest"},t}return r(t,e),t.prototype.init=function(){return i(this,void 0,void 0,(function(){var e;return n(this,(function(t){switch(t.label){case 0:return e=b.load(),this.addResolvingPromise(e),[4,this.when()];case 1:return t.sent(),[2]}}))}))},t.prototype.normalizeCtorArgs=function(e){return e&&e.ioConfig&&(e=a({},e,{ioConfig:a({resolution:null,bandIds:null,sampling:"closest",tileInfo:x.create()},e.ioConfig)})),e},Object.defineProperty(t.prototype,"url",{set:function(e){var t=m.urlToObject(e);this._set("url",t.path)},enumerable:!0,configurable:!0}),t.prototype.open=function(e){return i(this,void 0,void 0,(function(){return n(this,(function(e){throw new u("BaseRaster:open-not-implemented","open() is not implemented")}))}))},t.prototype.fetchTile=function(e,t,r,o){return void 0===o&&(o={}),i(this,void 0,void 0,(function(){var i,a,l,u;return n(this,(function(n){return i=o.tileInfo,a=i.lodAt(e),l=new s.Point({x:a.resolution,y:a.resolution,spatialReference:i.spatialReference}),u=this._getTileExtent(l,t,r,i),[2,this.fetchPixels(u,i.size[0],i.size[1],o)]}))}))},t.prototype.identify=function(e,t){return void 0===t&&(t={}),i(this,void 0,void 0,(function(){var r,o,i,a,s,l,u,c,f,p,h,m,d,y,x;return n(this,(function(n){switch(n.label){case 0:return r=this.rasterInfo,o=r.spatialReference,i=r.extent,a=t.datumTransformation,s=b.projectPoint(e,o,a),i.intersects(s)?(l=0,t.srcResolution?(u=b.snapPyramid(t.srcResolution,this.rasterInfo,this.ioConfig.sampling),l=u.pyramidLevel,[3,3]):[3,1]):[2,{location:s,value:null}];case 1:return[4,this.computeBestPyramidLevelForLocation(e,t)];case 2:if(null==(l=n.sent()))return[2,{location:s,value:null}];n.label=3;case 3:return null===(c=this.identifyPixelLocation(s,l,null))?[2,{location:s,value:null}]:(f=c.row,p=c.col,h=c.rowOffset,m=c.colOffset,[4,this.fetchRawTile(l,f,p,t)]);case 4:return(d=n.sent()).pixels&&d.pixels.length>0?(y=h*this.rasterInfo.storageInfo.blockHeight+m,x=!d.mask||d.mask[y]?d.pixels.map((function(e){return e[y]})):null,[2,{location:s,value:x,pyramidLevel:l}]):[2,{location:s,value:null}]}}))}))},t.prototype.fetchPixels=function(e,t,r,o){return void 0===o&&(o={}),i(this,void 0,void 0,(function(){var i,a,l,u,c,f,p,h,m,d,y,x,v,g,R,I,k,M,P,B,C,S;return n(this,(function(n){switch(n.label){case 0:return i=e.clone().normalize(),e=i[0],a=this.rasterInfo.spatialReference,l=!e.spatialReference.equals(a),u=o.datumTransformation,c=new s.Point({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/r,spatialReference:e.spatialReference}),(f=o.srcResolution||(l?b.projectResolution(c,a,e,u):c))?(p=b.snapPyramid(f,this.rasterInfo,this.ioConfig.sampling),h=p.pyramidLevel,m=p.pyramidResolution,p.excessiveReading?[2,null]:(d=this.rasterInfo.storageInfo,y=l?b.projectExtent(e,a,u):e,x={x:Math.floor((y.xmin-d.origin.x)/m.x+.1),y:Math.floor((d.origin.y-y.ymax)/m.y+.1)},v=Math.ceil((y.xmax-y.xmin)/m.x-.1),g=Math.ceil((y.ymax-y.ymin)/m.y-.1),v/t>8||g/r>8?[2,null]:[4,this.fetchRawPixels(h,x,{width:v,height:g},o)])):[2,null];case 1:return(R=n.sent())?(I=h>0?d.pyramidBlockWidth:d.blockWidth,k=h>0?d.pyramidBlockHeight:d.blockHeight,!l&&1===R.pixelBlocks.length&&I===t&&k===r&&f.x===c.x&&f.y===c.y?[2,{extent:e,srcExtent:y,pixelBlock:R.pixelBlocks[0],transformGrid:null}]:(M=b.getProjectionOffsetGrid(e,R.extent,c,u),B=!o.requestRawData,C={rows:M.spacing[0],cols:M.spacing[1]},this.rasterJobHandler?[4,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:R.pixelBlocks,srcMosaicSize:R.mosaicSize,destDimension:B?{width:t,height:r}:null,coefs:B?M.coefficients:null,sampleSpacing:B?C:null},o)]:[3,3])):[2,null];case 2:return P=n.sent(),[3,4];case 3:S=w.mosaic(R.pixelBlocks,R.mosaicSize),P=B?w.approximateTransform(S,{width:t,height:r},M.coefficients,C):S,n.label=4;case 4:return[2,{srcExtent:y,pixelBlock:P,transformGrid:M,extent:e}]}}))}))},t.prototype.fetchRawPixels=function(e,t,r,o){return i(this,void 0,void 0,(function(){var i,a,l,u,c,p,m,d,y,x,g,w,b,R,I,k,M,P,B,C,S,H,T,j,z,L,E,O;return n(this,(function(n){switch(n.label){case 0:if(i=this.rasterInfo.storageInfo,a=i.origin,l=i.blockBoundary,u=e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,c=e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight,p=Math.floor(t.x/u),m=Math.floor(t.y/c),d=Math.floor((t.x+r.width-1)/u),y=Math.floor((t.y+r.height-1)/c),x=this.rasterInfo,g=x.pixelSize,w=x.spatialReference,!(b=l[e]))return[2,null];if(R=b.minRow,I=b.minCol,k=b.maxCol,M=b.maxRow,y<R||d<I||m>M||p>k)return[2,null];for(P=[],B=this.url,C=o.registryId,T=m;T<=y;T++)for(j=p;j<=d;j++)T>=R&&j>=I&&M>=T&&k>=j?(S=e+"/"+T+"/"+j,H=v.getBlock(B,C,S),f.isSome(H)||(H=this.fetchRawTile(e,T,j,o),v.putBlock(B,C,S,H)),P.push(H)):P.push(null);return 0===P.length?[2,null]:[4,h.all(P)];case 1:return z=n.sent(),L={height:(y-m+1)*u,width:(d-p+1)*c},E=g.x*Math.pow(2,e),O=g.y*Math.pow(2,e),[2,{extent:new s.Extent({xmin:a.x+p*u*E,xmax:a.x+(d+1)*u*E,ymin:a.y-(y+1)*c*O,ymax:a.y-m*c*O,spatialReference:w}),pixelBlocks:z,mosaicSize:L}]}}))}))},t.prototype.fetchRawTile=function(e,t,r,o){return i(this,void 0,void 0,(function(){return n(this,(function(e){throw new u("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")}))}))},t.prototype.decodePixelBlock=function(e,t){return this.rasterJobHandler?this.rasterJobHandler.decode({data:e,options:t}):g.decode(e,t)},t.prototype.request=function(e,t){return i(this,void 0,void 0,(function(){var r,o,i,s,u,c;return n(this,(function(n){switch(n.label){case 0:r=this.ioConfig.customFetchParameters,o=e.url,i=e.range,s=e.query,u=e.responseType,null==e.retryCount&&this.ioConfig.retryCount&&(e.retryCount=this.ioConfig.retryCount),c=i?{Range:"bytes="+i.from+"-"+i.to}:null,n.label=1;case 1:return n.trys.push([1,3,,4]),[4,l(o,{query:a({},s,r),headers:c,responseType:u,signal:t})];case 2:return[2,n.sent().data];case 3:return n.sent(),e.retryCount>0?(e.retryCount--,[2,this.request(e,t)]):[2,null];case 4:return[2]}}))}))},t.prototype.getSliceIndex=function(e){var t=this.rasterInfo.multidimensionalInfo;if(!t||0===e.length)return null;for(var r=0,o=e[0].variableName,n=function(n){var i=t.variables[n],a=i.dimensions;if(i.name!==o)return r+=a.map((function(e){return e.values.length})).reduce((function(e,t){return e+t})),"break";for(var s=a.map((function(e){return e.values.length})),l=a.length,u=function(t){var o=e.filter((function(e){return e.dimensionName===a[t].name}))[0];if(null==o)return{value:null};var n=Array.isArray(o.values[0])?o.values[0][0]:o.values[0],i=a[t].values.indexOf(n);if(-1===i)return{value:null};s.shift(),r+=t===l-1?i:i*s.reduce((function(e,t){return e+t}))},c=0;c<l;c++){var f=u(c);if("object"==typeof f)return f}},i=0;i<t.variables.length;i++){var a=n(i);if("object"==typeof a)return a.value;if("break"===a)break}return r},t.prototype.computeBestPyramidLevelForLocation=function(e,t){return void 0===t&&(t={}),i(this,void 0,void 0,(function(){return n(this,(function(e){return[2,0]}))}))},t.prototype.identifyPixelLocation=function(e,t,r){var o=this.rasterInfo,n=o.spatialReference,i=o.pixelSize,a=o.extent,s=this.rasterInfo.storageInfo,l=s.blockWidth,u=s.blockHeight,c=s.maximumPyramidLevel,f=s.pyramidScalingFactor,p=s.origin,h=s.blockBoundary,m=b.projectPoint(e,n,r);if(!a.intersects(m))return null;if(t<0||t>c)return null;var d=Math.pow(f,t),y=d*i.x,x=d*i.y,v=h[t],g=Math.max(v.minRow,Math.min(v.maxRow,(p.y-m.y)/x/u)),w=Math.max(v.minCol,Math.min(v.maxCol,(m.x-p.x)/y/l)),R=Math.min(u-1,Math.floor((g-Math.floor(g))*u)),I=Math.min(l-1,Math.floor((w-Math.floor(w))*l));return{pyramidLevel:t,row:Math.floor(g),col:Math.floor(w),rowOffset:R,colOffset:I,srcLocation:m}},t.prototype._getTileExtent=function(e,t,r,o){var n=o.origin,i=o.spatialReference,a=o.size[0],l=o.size[1],u=n.x+r*a*e.x,c=u+a*e.x,f=n.y-t*l*e.y,p=f-l*e.y;return new s.Extent({xmin:u,xmax:c,ymin:p,ymax:f,spatialReference:i})},o([d.property(y.url)],t.prototype,"url",null),o([d.property({type:String,json:{write:!0}})],t.prototype,"datasetName",void 0),o([d.property({type:String,json:{write:!0}})],t.prototype,"datasetFormat",void 0),o([d.property()],t.prototype,"rasterInfo",void 0),o([d.property()],t.prototype,"ioConfig",void 0),t=o([d.subclass("esri.layers.support.rasterDatasets.BaseRaster")],t)}(d.declared(p.EsriPromiseMixin(c.JSONSupport)))}));