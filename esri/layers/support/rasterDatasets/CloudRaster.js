// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/declareExtendsHelper","../../../geometry","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators","../RasterInfo","../RasterStorageInfo","../TileInfo","./BaseRaster","./DBFParser","../../../tasks/support/FeatureSet"],(function(e,t,r,n,i,o,a,s,l,u,f,p,c,d,h,m,y){var g=new Map;g.set("int16","esriFieldTypeSmallInteger"),g.set("int32","esriFieldTypeInteger"),g.set("int64","esriFieldTypeInteger"),g.set("float32","esriFieldTypeSingle"),g.set("float64","esriFieldTypeDouble"),g.set("text","esriFieldTypeString");return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.storageInfo=null,t}return o(t,e),t.prototype.open=function(e){return i(this,void 0,void 0,(function(){var t,n,i,o,a,u;return r(this,(function(r){switch(r.label){case 0:return[4,this.init()];case 1:return r.sent(),t=e?l.unwrap(e.signal):null,[4,this.request({url:this.url+"/conf.json",responseType:"json"},t)];case 2:if(n=r.sent(),!this._validateHeader(n))throw new s("cloudraster:open","Invalid or unsupported conf.json.");return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),i=this._parseHeader(n),o=i.storageInfo,"thematic"!==(a=i.rasterInfo).dataType?[3,4]:[4,this._fetchAuxiliaryInformation()];case 3:u=r.sent(),a.attributeTable=u,r.label=4;case 4:return this._set("storageInfo",o),this._set("rasterInfo",a),this.ioConfig.retryCount=this.ioConfig.retryCount||0,[2]}}))}))},t.prototype.fetchRawTile=function(e,t,n,o){return void 0===o&&(o={}),i(this,void 0,void 0,(function(){var i,a,s,l,u,f,p;return r(this,(function(r){switch(r.label){case 0:return(i=this.rasterInfo.storageInfo.maximumPyramidLevel-e)<0?[2,null]:(a=this._buildCacheFilePath(i,t,n,o.multidimensionalDefinition),s=this._getIndexRecordFromBundle(t,n),[4,this.request({url:a,range:{from:0,to:this.storageInfo.headerSize-1},responseType:"array-buffer"},o.signal)]);case 1:return(l=r.sent())?(u=new Uint8Array(l),0===(f=this._getTileEndAndContentType(u,s)).recordSize?[2,null]:[4,this.request({url:a,range:{from:f.position,to:f.position+f.recordSize},responseType:"array-buffer"},o.signal)]):[2,null];case 2:return(p=r.sent())?[2,this.decodePixelBlock(p,{width:this.rasterInfo.storageInfo.tileInfo.size[0],height:this.rasterInfo.storageInfo.tileInfo.size[1],planes:null,pixelType:null})]:[2,null]}}))}))},t.prototype._validateHeader=function(e){return e&&"RasterInfo"===e.type&&!["origin","extent","geodataXform","LODInfos","blockWidth","blockHeight","bandCount","pixelType","pixelSizeX","pixelSizeY","format","packetSize"].some((function(t){return!e[t]}))},t.prototype._parseHeader=function(e){var t,r,n,i,o=["u1","u2","u4","u8","s8","u16","s16","u32","s32","f32","f64"][e.pixelType],s=e.bandCount,l=e.histograms,u=e.colormap,f=e.blockWidth,h=e.blockHeight,m=e.firstPyramidLevel,y=e.maximumPyramidLevel,g=e.statistics&&e.statistics.map((function(e){return{min:e.min,max:e.max,avg:e.mean,stddev:e.standardDeviation,median:e.median,mode:e.mode}})),x=new a.SpatialReference(e.extent.spatialReference||e.geodataXform.spatialReference),v=new a.Extent({xmin:e.extent.xmin,ymin:e.extent.ymin,xmax:e.extent.xmax,ymax:e.extent.ymax,spatialReference:x}),I=new a.Point({x:e.pixelSizeX,y:e.pixelSizeY,spatialReference:x}),S=e.properties,b=e.format.toLowerCase().replace("cache/",""),w=new a.Point(e.origin.x,e.origin.y,x);if(u&&u.colors)for(t=[],r=0;r<u.colors.length;r++)n=u.colors[r],i=u.values?u.values[r]:r,t.push([i,255&n,n<<16>>>24,n<<8>>>24,n>>>24]);var T=e.LODInfos,z=[];for(r=0;r<T.levels.length;r++)z.push({level:T.levels[r],resolution:T.resolutions[r],scale:96/.0254*T.resolutions[r]});var R=new d({dpi:96,lods:z,format:b,origin:w,size:[f,h],spatialReference:x}),k={recordSize:8,packetSize:e.packetSize,headerSize:e.packetSize*e.packetSize*8+64},_=Math.round((v.xmax-v.xmin)/I.x),C=Math.round((v.ymax-v.ymin)/I.y),H=[{maxCol:Math.ceil(_/f)-1,maxRow:Math.ceil(C/h)-1,minCol:0,minRow:0}],F=2;if(y>0)for(r=0;r<y;r++)H.push({maxCol:Math.ceil(_/F/f)-1,maxRow:Math.ceil(C/F/h)-1,minCol:0,minRow:0}),F*=2;var P=e.mdInfo;return{storageInfo:k,rasterInfo:new p({width:_,height:C,pixelType:o,bandCount:s,extent:v,spatialReference:x,pixelSize:I,keyProperties:S,statistics:g,histograms:l,multidimensionalInfo:P,colormap:t,storageInfo:new c({blockWidth:f,blockHeight:h,pyramidBlockWidth:f,pyramidBlockHeight:h,origin:w,tileInfo:R,firstPyramidLevel:m,maximumPyramidLevel:y,blockBoundary:H})})}},t.prototype._fetchAuxiliaryInformation=function(e){return i(this,void 0,void 0,(function(){var t,n,i,o,a,s,l,f;return r(this,(function(r){switch(r.label){case 0:return t=this.request({url:this.url+"/conf.vat.json",responseType:"json"},e).then((function(e){return e})).catch((function(){return null})),n=this.request({url:this.url+"/conf.vat.dbf",responseType:"array-buffer"},e).then((function(e){return e})).catch((function(){return null})),[4,u.all([t,n])];case 1:return(i=r.sent())[0]&&(a=i[0].fields,s=i[0].values,a&&s&&(a=a.map((function(e){return{type:"OID"===e.name?"esriFieldTypeOID":g.get(e.type),name:e.name,alias:e.alias||e.name}})),l=s.map((function(e){return{attributes:e}})),a&&s&&(o={fields:a,features:l}))),!o&&i[1]&&(f=m.parse(i[1]),o=f.recordSet),[2,y.fromJSON(o)]}}))}))},t.prototype._buildCacheFilePath=function(e,t,r,n){var i=this.storageInfo.packetSize,o=Math.floor(t/i)*i,a=Math.floor(r/i)*i,s="R"+this._toHexString4(o)+"C"+this._toHexString4(a),l="L";l+=e>=10?e.toString():"0"+e.toString();var u=n&&n[0];if(!u)return this.url+"/_alllayers/"+l+"/"+s+".bundle";for(var f=this.rasterInfo.multidimensionalInfo.variables.filter((function(e){return e.name===u.variableName}))[0].dimensions[0].values.indexOf(u.values[0]).toString(16),p=4-f.length,c=0;c<p;c++)f="0"+f;return f="S"+f,this.url+"/_alllayers/"+u.variableName+"/"+f+"/"+l+"/"+s+".bundle"},t.prototype._getIndexRecordFromBundle=function(e,t){var r=this.storageInfo.packetSize,n=r*(e%r)+t%r;if(n<0)throw"Invalid level / row / col";return 20+n*this.storageInfo.recordSize+44},t.prototype._getTileEndAndContentType=function(e,t){var r,n=e.subarray(t,t+8),i=0;for(r=0;r<5;r++)i|=(255&n[r])<<8*r;var o=0xffffffffff&i;for(i=0,r=5;r<8;r++)i|=(255&n[r])<<8*(r-5);return{position:o,recordSize:0xffffffffff&i}},t.prototype._toHexString4=function(e){var t=e.toString(16);if(4!==t.length)for(var r=4-t.length;r-- >0;)t="0"+t;return t},n([f.property({readOnly:!0})],t.prototype,"storageInfo",void 0),n([f.property({type:String,json:{write:!0}})],t.prototype,"datasetFormat",void 0),t=n([f.subclass("esri.layers.support.rasterDatasets.CloudRaster")],t)}(f.declared(h))}));