// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../PixelBlock"],(function(t,e,r){Object.defineProperty(e,"__esModule",{value:!0});var i=function(t){return t&&"esri.layers.support.PixelBlock"===t.declaredClass&&t.pixels&&t.pixels.length>0};function n(t,e){var r,i,n=Math.min(Math.max(t,-100),100),a=Math.min(Math.max(e,-100),100),o=new Uint8Array(256);for(r=0;r<256;r++)n>0&&n<100?i=(200*r-25500+510*a)/(2*(100-n))+128:n<=0&&n>-100?i=(200*r-25500+510*a)*(100+n)/2e4+128:100===n?i=(i=200*r-25500+256*(100-n)+510*a)>0?255:0:-100===n&&(i=128),o[r]=i>255?255:i<0?0:i;return o}function a(t,e,r,i,n,a,o,l){return{xmin:n<=r*t?0:n<r*t+t?n-r*t:t,ymin:a<=i*e?0:a<i*e+e?a-i*e:e,xmax:n+o<=r*t?0:n+o<r*t+t?n+o-r*t:t,ymax:a+l<=i*e?0:a+l<i*e+e?a+l-i*e:e}}function o(t,e,n,o){var l=t.filter((function(t){return i(t)}))[0];if(null==l)return null;var f,h,u,s,x,p,m,c,d,w,y,g,v,M=o?o.width:e.width,k=o?o.height:e.height,A=l.width,U=l.height,C=e.width/A,T=e.height/U,B=n?n.x:0,S=n?n.y:0,O=l.pixelType,P=r.getPixelArrayConstructor(O),b=l.pixels.length,D=[];for(p=0;p<b;p++){for(h=new P(M*k),m=0;m<T;m++)for(c=0;c<C;c++)if(u=t[m*C+c])for(f=u.pixels[p],d=(y=a(A,U,c,m,B,S,M,k)).ymin;d<y.ymax;d++)for(s=(m*U+d-S)*M+(c*A-B),x=d*A,w=y.xmin;w<y.xmax;w++)h[s+w]=f[x+w];D.push(h)}if(t.some((function(t){return null==t||t.mask&&t.mask.length>0})))for(g=new Uint8Array(M*k),m=0;m<T;m++)for(c=0;c<C;c++)if(v=(u=t[m*C+c])?u.mask:null,y=a(A,U,c,m,B,S,M,k),v)for(d=y.ymin;d<y.ymax;d++)for(s=(m*U+d-S)*M+(c*A-B),x=d*A,w=y.xmin;w<y.xmax;w++)g[s+w]=v[x+w];else if(u)for(d=y.ymin;d<y.ymax;d++)for(s=(m*U+d-S)*M+(c*A-B),x=d*A,w=y.xmin;w<y.xmax;w++)g[s+w]=1;else for(d=y.ymin;d<y.ymax;d++)for(s=(m*U+d-S)*M+(c*A-B),x=d*A,w=y.xmin;w<y.xmax;w++)g[s+w]=0;var I=new r({width:M,height:k,pixels:D,pixelType:O,mask:g});return I.updateStatistics(),I}e.extractBands=function(t,e){if(!e||!i(t))return t;var n=t.pixels.length;return e&&e.some((function(t){return t>=n}))?t:1===n&&1===e.length&&0===e[0]?t:n!==e.length||e.some((function(t,e){return t!==e}))?new r({pixelType:t.pixelType,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:e.map((function(e){return t.pixels[e]})),statistics:t.statistics&&e.map((function(e){return t.statistics[e]}))}):t},e.createColormapLUT=function(t){if(t){var e=t.colormap;if(e&&0!==e.length){var r=e.sort((function(t,e){return t[0]-e[0]})),i=0;r[0][0]<0&&(i=r[0][0]);var n,a=Math.max(256,r[r.length-1][0]-i+1),o=new Uint8Array(4*a),l=[],f=0,h=0,u=5===r[0].length;if(a>65536)return r.forEach((function(t){l[t[0]-i]=u?t.slice(1):t.slice(1).concat([255])})),{indexed2DColormap:l,offset:i,alphaSpecified:u};if(t.fillUnspecified)for(f=(n=r[h])[0]-i;f<a;f++)o[4*f]=n[1],o[4*f+1]=n[2],o[4*f+2]=n[3],o[4*f+3]=u?n[4]:255,f===n[0]-i&&(n=h===r.length-1?n:r[++h]);else for(f=0;f<r.length;f++)o[h=4*((n=r[f])[0]-i)]=n[1],o[h+1]=n[2],o[h+2]=n[3],o[h+3]=u?n[4]:255;return{indexedColormap:o,offset:i,alphaSpecified:u}}}},e.colorize=function(t,e){if(!i(t))return t;if(!e&&(e.indexedColormap||e.indexed2DColormap))return t;var r=t.clone(),n=r.pixels,a=r.mask,o=r.width*r.height;if(1!==n.length)return t;var l,f=e.indexedColormap,h=e.indexed2DColormap,u=e.offset,s=e.alphaSpecified,x=f.length-1,p=0,m=n[0],c=new Uint8Array(m.length),d=new Uint8Array(m.length),w=new Uint8Array(m.length),y=0;if(f)if(a)for(p=0;p<o;p++)a[p]&&((y=4*(m[p]-u))<u||y>x?a[p]=0:(c[p]=f[y],d[p]=f[y+1],w[p]=f[y+2],a[p]=f[y+3]));else{for(a=new Uint8Array(o),p=0;p<o;p++)(y=4*(m[p]-u))<u||y>x?a[p]=0:(c[p]=f[y],d[p]=f[y+1],w[p]=f[y+2],a[p]=f[y+3]);r.mask=a}else if(a)for(p=0;p<o;p++)a[p]&&(l=h[m[p]],c[p]=l[0],d[p]=l[1],w[p]=l[2],a[p]=l[3]);else{for(a=new Uint8Array(o),p=0;p<o;p++)l=h[m[p]],c[p]=l[0],d[p]=l[1],w[p]=l[2],a[p]=l[3];r.mask=a}return r.pixels=[c,d,w],r.statistics=null,r.pixelType="u8",r.maskIsAlpha=s,r},e.estimateStatisticsHistograms=function(t){if(!i(t))return null;t.statistics||t.updateStatistics();var e,r,n,a,o,l,f,h,u,s,x,p,m,c,d=t.pixels,w=t.mask,y=t.pixelType,g=t.statistics,v=t.width*t.height,M=d.length,k=[],A=[];for(a=0;a<M;a++){if(l=new Uint32Array(256),h=d[a],"u8"===y)if(e=-.5,r=255.5,w)for(o=0;o<v;o++)w[o]&&l[h[o]]++;else for(o=0;o<v;o++)l[h[o]]++;else{if(e=g[a].minValue,n=((r=g[a].maxValue)-e)/256,f=new Uint32Array(257),w)for(o=0;o<v;o++)w[o]&&f[Math.floor((h[o]-e)/n)]++;else for(o=0;o<v;o++)f[Math.floor((h[o]-e)/n)]++;for(o=0;o<255;o++)l[o]=f[o];l[255]=f[255]+f[256]}for(k.push({min:e,max:r,size:256,counts:l}),u=0,s=0,m=0,o=0;o<256;o++)u+=l[o],s+=o*l[o];for(c=s/u,o=0;o<256;o++)m+=l[o]*Math.pow(o-c,2);x=(c+.5)*(n=(r-e)/256)+e,p=Math.sqrt(m/(u-1))*n,A.push({min:e,max:r,avg:x,stddev:p})}return{statistics:A,histograms:k}},e.createStretchLUT=function(t){var e=t.minCutOff,r=t.maxCutOff,i=t.gamma,a=t.pixelType,o=t.outMin||0,l=t.outMax||255;if(-1===["u8","u16","s8","s16"].indexOf(a))return null;var f,h,u=e.length,s=0;"s8"===a?s=-127:"s16"===a&&(s=-32767);var x=256;["u16","s16"].indexOf(a)>-1&&(x=65536);var p=[],m=[],c=l-o;for(f=0;f<u;f++)m[f]=r[f]-e[f],p[f]=c/(r[f]-e[f]);var d,w=i&&i.length>=u,y=[];if(w)for(f=0;f<u;f++)i[f]>1?i[f]>2?y[f]=6.5+Math.pow(i[f]-2,2.5):y[f]=6.5+100*Math.pow(2-i[f],4):y[f]=1;var g,v,M,k=[];if(w)for(f=0;f<u;f++){for(M=[],h=0;h<x;h++)d=((g=h+s)-e[f])/m[f],v=1,i[f]>1&&(v-=Math.pow(1/c,d*y[f])),g<r[f]&&g>e[f]?M[h]=Math.floor(v*c*Math.pow(d,1/i[f]))+o:g>=r[f]?M[h]=l:M[h]=o;k[f]=M}else for(f=0;f<u;f++){for(M=[],h=0;h<x;h++)(g=h+s)<=e[f]?M[h]=o:g>=r[f]?M[h]=l:M[h]=Math.floor((g-e[f])/m[f]*c)+o;k[f]=M}if(null!=t.contrastOffset){var A=n(t.contrastOffset,t.brightnessOffset);for(f=0;f<u;f++)for(M=k[f],h=0;h<x;h++)M[h]=A[M[h]]}return{lut:k,offset:s}},e.createContrastBrightnessLUT=n,e.stretch=function(t,e){if(!i(t))return null;var r,n,a,o,l,f=t.clone(),h=f.pixels,u=f.mask,s=e.minCutOff,x=e.maxCutOff,p=e.gamma,m=e.outMin||0,c=e.outMax||255,d=f.width*f.height,w=h.length,y=c-m,g=[],v=[];for(r=0;r<w;r++)v[r]=x[r]-s[r],g[r]=y/(x[r]-s[r]);var M=p&&p.length>=w,k=[];if(M)for(r=0;r<w;r++)p[r]>1?p[r]>2?k[r]=6.5+Math.pow(p[r]-2,2.5):k[r]=6.5+100*Math.pow(2-p[r],4):k[r]=1;if(M)if(null!=u){for(n=0;n<d;n++)if(u[n])for(r=0;r<w;r++)l=((a=h[r][n])-s[r])/v[r],o=1,p[r]>1&&(o-=Math.pow(1/y,l*k[r])),a<x[r]&&a>s[r]?h[r][n]=Math.floor(o*y*Math.pow(l,1/p[r]))+m:a>=x[r]?h[r][n]=c:h[r][n]=m}else for(n=0;n<d;n++)for(r=0;r<w;r++)l=((a=h[r][n])-s[r])/v[r],o=1,p[r]>1&&(o-=Math.pow(1/y,l*k[r])),a<x[r]&&a>s[r]?h[r][n]=Math.floor(o*y*Math.pow(l,1/p[r]))+m:a>=x[r]?h[r][n]=c:h[r][n]=m;else if(null!=u){for(n=0;n<d;n++)if(u[n])for(r=0;r<w;r++)(a=h[r][n])<x[r]&&a>s[r]?h[r][n]=Math.floor((a-s[r])/v[r]*y)+m:a>=x[r]?h[r][n]=c:h[r][n]=m}else for(n=0;n<d;n++)for(r=0;r<w;r++)(a=h[r][n])<x[r]&&a>s[r]?h[r][n]=Math.floor((a-s[r])/v[r]*y)+m:a>=x[r]?h[r][n]=c:h[r][n]=m;return f.pixelType="u8",f.updateStatistics(),f},e.lookupPixels=function(t,e){if(!i(t))return null;var n,a,o=t.pixels,l=t.mask,f=t.width*t.height,h=o.length,u=e.lut,s=e.offset;u&&1===u[0].length&&(u=o.map((function(){return u})));var x,p,m,c=[];if(s)if(null==l)for(n=0;n<h;n++){for(x=o[n],p=u[n],m=new Uint8Array(f),a=0;a<f;a++)m[a]=p[x[a]-s];c.push(m)}else for(n=0;n<h;n++){for(x=o[n],p=u[n],m=new Uint8Array(f),a=0;a<f;a++)l[a]&&(m[a]=p[x[a]-s]);c.push(m)}else if(null==l)for(n=0;n<h;n++){for(x=o[n],p=u[n],m=new Uint8Array(f),a=0;a<f;a++)m[a]=p[x[a]];c.push(m)}else for(n=0;n<h;n++){for(x=o[n],p=u[n],m=new Uint8Array(f),a=0;a<f;a++)l[a]&&(m[a]=p[x[a]]);c.push(m)}var d=new r({width:t.width,height:t.height,pixels:c,mask:l,pixelType:"u8"});return d.updateStatistics(),d},e.remapColor=function(t,e){if(!i(t))return null;var r,n,a,o,l,f,h=t.clone(),u=h.pixels,s=h.width*h.height,x=e.length,p=Math.floor(x/2),m=e[Math.floor(p)],c=u[0],d=!1,w=new Uint8Array(s),y=new Uint8Array(s),g=new Uint8Array(s),v=h.mask,M=4===e[0].mappedColor.length;for(v||((v=new Uint8Array(s)).fill(M?255:1),h.mask=v),l=0;l<s;l++)if(v[l]){for(r=c[l],d=!1,f=p,n=m,a=0,o=x-1;o-a>1;){if(r===n.value){d=!0;break}r>n.value?a=f:o=f,f=Math.floor((a+o)/2),n=e[Math.floor(f)]}d||(r===e[a].value?(n=e[a],d=!0):r===e[o].value?(n=e[o],d=!0):r<e[a].value?(d=!1,n=null):r>e[a].value&&(r<e[o].value?(n=e[a],d=!0):o===x-1?(d=!1,n=null):(n=e[o],d=!0))),d?(w[l]=n.mappedColor[0],y[l]=n.mappedColor[1],g[l]=n.mappedColor[2],v[l]=n.mappedColor[3]):w[l]=y[l]=g[l]=v[l]=0}return h.pixels=[w,y,g],h.mask=v,h.pixelType="u8",h.maskIsAlpha=M,h},e.getClipBounds=a,e.mosaicPixelData=function(t,e){if(!t||0===t.length)return null;var r=t.filter((function(t){return t.pixelBlock}))[0];if(!r)return null;var i=(r.extent.xmax-r.extent.xmin)/r.pixelBlock.width,n=(r.extent.ymax-r.extent.ymin)/r.pixelBlock.height,a=.01*Math.min(i,n),l=t.sort((function(t,e){return Math.abs(t.extent.ymax-e.extent.ymax)>a?e.extent.ymax-t.extent.ymax:Math.abs(t.extent.xmin-e.extent.xmin)>a?t.extent.xmin-e.extent.xmin:0})),f=Math.min.apply(null,l.map((function(t){return t.extent.xmin}))),h=Math.min.apply(null,l.map((function(t){return t.extent.ymin}))),u=Math.max.apply(null,l.map((function(t){return t.extent.xmax}))),s=Math.max.apply(null,l.map((function(t){return t.extent.ymax}))),x={x:Math.round((e.xmin-f)/i),y:Math.round((s-e.ymax)/n)},p={width:Math.round((u-f)/i),height:Math.round((s-h)/n)},m={width:Math.round((e.xmax-e.xmin)/i),height:Math.round((e.ymax-e.ymin)/n)};return Math.round(p.width/r.pixelBlock.width)*Math.round(p.height/r.pixelBlock.height)!==l.length||x.x<0||x.y<0||p.width<m.width||p.height<m.height?null:{extent:e,pixelBlock:o(l.map((function(t){return t.pixelBlock})),p,x,m)}},e.mosaic=o,e.setValidBoundary=function(t,e,r){if(!i(t))return null;var n=t.width,a=t.height,o=e.x,l=e.y,f=r.width+o,h=r.height+l;if(o<0||l<0||f>n||h>a)return t;if(0===o&&0===l&&f===n&&h===a)return t;t.mask||(t.mask=new Uint8Array(n*a));for(var u=t.mask,s=0;s<a;s++)for(var x=s*n,p=0;p<n;p++)u[x+p]=s<l||s>=h||p<o||p>=f?0:1;return t.updateStatistics(),t},e.clip=function(t,e,n){if(!i(t))return null;var a=e.x,o=e.y,l=e.x+n.width,f=e.x+n.height;if(f===t.height&&l===t.width)return t;for(var h,u=t.pixels,s=t.mask,x=t.width,p=x*t.height,m=u.length,c=[],d=0;d<m;d++){for(var w=u[d],y=r.createEmptyBand(t.pixelType,p),g=0,v=o;v<=f;v++)for(var M=v*x,k=a;k<=l;k++)y[g++]=w[M+k];c.push(y)}if(s){h=new Uint8Array(n.width*n.height);for(g=0,v=o;v<=f;v++)for(M=v*x,k=a;k<=l;k++)h[g++]=s[M+k]}var A=new r({width:n.width,height:n.height,pixels:c,mask:h});return A.updateStatistics(),A},e.approximateTransform=function(t,e,n,a){if(!i(t))return null;for(var o,l,f,h,u,s,x,p=t.pixels,m=t.mask,c=t.pixelType,d=t.width,w=t.height,y=r.getPixelArrayConstructor(c),g=p.length,v=e.width,M=e.height,k=a.cols,A=a.rows,U=Math.ceil(v/k),C=Math.ceil(M/A),T=!1,B=0;B<n.length;B+=3)-1===n[B]&&-1===n[B+1]&&-1===n[B+2]&&(T=!0);var S,O,P=new Float32Array(v*M),b=new Float32Array(v*M),D=0;for(B=0;B<C;B++)for(var I=0;I<U;I++){l=n[o=12*(B*U+I)],f=n[o+1],h=n[o+2],u=n[o+3],s=n[o+4],x=n[o+5];for(var L=0;L<A;L++){D=(B*A+L)*v+I*k,O=(L+.5)/A;for(var V=0;V<L;V++)S=(V+.5)/k,P[D+V]=Math.round((l*S+f*O+h)*d-.5),b[D+V]=Math.round((u*S+s*O+x)*w-.5)}l=n[o+=6],f=n[o+1],h=n[o+2],u=n[o+3],s=n[o+4],x=n[o+5];for(L=0;L<A;L++){D=(B*A+L)*v+I*k,O=(L+.5)/A;for(V=L;V<k;V++)S=(V+.5)/k,P[D+V]=Math.round((l*S+f*O+h)*d-.5),b[D+V]=Math.round((u*S+s*O+x)*w-.5)}}for(var q,z=function(t,e){for(var r=0;r<M;r++){o=r*v;for(var i=0;i<v;i++)T&&(P[o]<0||b[o]<0)?t[o]=0:t[o]=e[P[o]+b[o]*d],o++}},E=[],F=0;F<g;F++)z(q=new y(v*M),p[F]),E.push(q);var _=new r({width:v,height:M,pixelType:c,pixels:E});if(m)_.mask=new Uint8Array(v*M),z(_.mask,m);else if(T){_.mask=new Uint8Array(v*M);for(B=0;B<v*M;B++)_.mask[B]=P[B]<0||b[B]<0?0:1}return _.updateStatistics(),_}}));