// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../rasterRenderers","../../core/arrayUtils","../../core/lang","./RasterFunction","../../renderers/support/colorRampUtils","../../renderers/support/stretchRendererUtils"],(function(e,r,t,n,a,o,i,u){Object.defineProperty(r,"__esModule",{value:!0});var s={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767]},l={type:"multipart",colorRamps:[{fromColor:[0,0,255],toColor:[0,255,255]},{fromColor:[0,255,255],toColor:[255,255,0]},{fromColor:[255,255,0],toColor:[255,0,0]}]};r.isSupportedRendererType=function(e){var r=e.type;return"raster-stretch"===r||"unique-value"===r||"class-breaks"===r},r.combineRenderingRules=function(e,r){if(!e||!r)return a.clone(e||r);var t=a.clone(e);return"none"!==r.functionName.toLowerCase()&&((function e(r){var t=r.Raster;if(t&&"esri.layers.support.RasterFunction"===t.declaredClass)return e(t.functionArguments);return r}(t.functionArguments)).Raster=r),t},r.convertRendererToRenderingRule=function(e,r){switch(r=r||{},e.type){case"raster-stretch":return function(e,r){var t=new o;t.functionName="Stretch";var n=m[u.stretchTypeJSONDict.toJSON(e.stretchType)],a={StretchType:n,Statistics:e.statistics,DRA:e.dynamicRangeAdjustment,UseGamma:e.useGamma,Gamma:e.gamma,ComputeGamma:e.computeGamma};null!=e.outputMin&&(a.Min=e.outputMin);null!=e.outputMax&&(a.Max=e.outputMax);n===m.standardDeviation?(a.NumberOfStandardDeviations=e.numberOfStandardDeviations,t.outputPixelType="u8"):n===m.percentClip?(a.MinPercent=e.minPercent,a.MaxPercent=e.maxPercent,t.outputPixelType="u8"):n===m.minMax?t.outputPixelType="u8":n===m.sigmoid&&(a.SigmoidStrengthLevel=e.sigmoidStrengthLevel);if(t.functionArguments=a,t.variableName="Raster",e.colorRamp){var s=e.colorRamp,l=new o,c=i.getColorRampName(s);return c?l.functionArguments={colorRamp:c}:!r.convertColorRampToColormap||"algorithmic"!==s.type&&"multipart"!==s.type?l.functionArguments={colorRamp:e.colorRamp.toJSON()}:l.functionArguments={Colormap:i.convertColorRampToColormap(s,256)},l.variableName="Raster",l.functionName="Colormap",l.functionArguments.Raster=t,l}return t}(e,r);case"class-breaks":return function(e,r){var t=[],n=[],a=[],i=[],u=r.pixelType,s=r.rasterAttributeTable,l=s&&s.features,m=f(s);if(l&&Array.isArray(l)&&e.classBreakInfos){e.classBreakInfos.forEach((function(r,t){var n,a=r.symbol.color;a.a&&l.forEach((function(o){((n=o.attributes[e.field])>=r.minValue&&n<r.maxValue||t===e.classBreakInfos.length-1&&n>=r.minValue)&&i.push([o.attributes[m],a.r,a.g,a.b])}))}));var p=u?c(i,u):i,d=new o;return d.functionName="Colormap",d.functionArguments={},d.functionArguments.Colormap=p,d.variableName="Raster",d}e.classBreakInfos.forEach((function(e,r){var o=e.symbol&&e.symbol.color;o.a?(0===r?t.push(e.minValue,e.maxValue+1e-6):t.push(e.minValue+1e-6,e.maxValue+1e-6),n.push(r),i.push([r,o.r,o.g,o.b])):a.push(e.minValue,e.maxValue)}));var v=u?c(i,u):i,g=new o;g.functionName="Remap",g.functionArguments={InputRanges:t,OutputValues:n,NoDataRanges:a},g.variableName="Raster";var C=new o;return C.functionName="Colormap",C.functionArguments={Colormap:v,Raster:g},C}(e,r);case"unique-value":return function(e,r){var t=[],n=r.pixelType,a=r.rasterAttributeTable,i=a&&a.features,u=f(a),s=!1;e.uniqueValueInfos&&e.uniqueValueInfos.forEach((function(r){var n=r.symbol.color;n.a&&(e.field!==u&&i?i&&i.forEach((function(a){String(a.attributes[e.field])===String(r.value)&&t.push([a.attributes[u],n.r,n.g,n.b])})):isNaN(r.value)?s=!0:t.push([r.value,n.r,n.g,n.b]))}));if(s)return null;var l=n&&t.length>0?c(t,n):t,m=new o;return m.functionName="Colormap",m.functionArguments={},m.functionArguments.Colormap=l,m.variableName="Raster",m}(e,r);case"raster-colormap":return function(e,r){var t=e.extractColormap();if(!t||0===t.length)return;var n=r.pixelType,a=n?c(t,n):t,i=new o;return i.functionName="Colormap",i.functionArguments={},i.functionArguments.Colormap=a,i}(e,r)}},r.createDefaultRenderer=function(e,r){if(e){var n,a=e.attributeTable,o=e.dataType,i=e.bandCount,u=e.pixelType,s=e.colormap,m=e.statistics,c=e.histograms;if(r&&r.length>0&&(m=m?r.map((function(e){return m[e]})):null,c=c?r.map((function(e){return c[e]})):null),1===i&&s&&s.length>0)n=t.RasterColormapRenderer.createFromColormap(s);else if(1===i&&a){var f=a.fields.filter((function(e){return"red"===e.name.toLowerCase()}))[0],p=a.fields.filter((function(e){return"green"===e.name.toLowerCase()}))[0],d=a.fields.filter((function(e){return"blue"===e.name.toLowerCase()}))[0],v=a.fields.filter((function(e){return"value"===e.name}))[0],g=a.fields.filter((function(e){return"classname"===e.name.toLowerCase()}))[0];g||(g=a.fields.filter((function(e){return"string"===e.type}))[0])||(g=v),f&&p&&d&&g&&(n=t.UniqueValueRenderer.fromJSON({field1:g.name,uniqueValueInfos:a.features.map((function(e){return{value:e.attributes[g.name],label:e.attributes[g.name],symbol:{color:[e.attributes[f.name],e.attributes[p.name],e.attributes[d.name],255],type:"esriSFS",style:"esriSFSSolid"}}}))}))}if(!n){var C=void 0,b=!1,R=void 0,h=void 0,y=void 0;"u8"===u&&"processed"===o?(C="min-max",m=m||[{min:0,max:255},{min:0,max:255},{min:0,max:255}]):"u8"===u||"elevation"===o?(C="min-max",b=!m):"scientific"===o?(C="min-max",b=!m,R=l):c&&c.length>0?(C="percent-clip",y=h=.25):m?C="min-max":(C="percent-clip",b=!0),n=t.RasterStretchRenderer.fromJSON({stretchType:C,dra:b,colorRamp:R,min:0,max:255,statistics:b?null:m,histograms:b?null:c,maxPercent:h,minPercent:y})}return n}},r.getDefaultBandCombination=function(e){var r=e.bandCount;if(1===r)return null;if(2===r)return[0];var t,n,a,o,i,u=e.keyProperties&&e.keyProperties.BandProperties;if(u&&u.length===r){for(var s=0;s<u.length;s++)u[s].BandName&&"red"===u[s].BandName.toLowerCase()&&(n=s),u[s].BandName&&"green"===u[s].BandName.toLowerCase()&&(a=s),u[s].BandName&&"blue"===u[s].BandName.toLowerCase()&&(o=s),u[s].BandName&&"nearinfrared"===u[s].BandName.toLowerCase()&&(i=s);void 0!==n&&void 0!==a&&void 0!==o?t=[n,a,o]:void 0!==n&&void 0!==a&&void 0!==i&&(t=[i,n,a])}return!t&&r>3&&(t=[0,1,2]),t};var m={none:0,standardDeviation:3,histogramEqualization:4,minMax:5,percentClip:6,sigmoid:9};function c(e,r){var t=s[String(r).toLowerCase()];return t&&e.push([Math.floor(t[0]-1),0,0,0],[Math.ceil(t[1]+1),0,0,0]),e}function f(e){if(e){var r=e.fields,t=r&&n.find(r,(function(e){return e&&e.name&&"value"===e.name.toLowerCase()}));return t&&t.name}}}));