// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/assignHelper","../../../core/Error","../PixelBlock","./ImageCanvasDecoder","./JpgPlus","./Lerc2Codec","./LercCodec","./Png","./Raw","./TiffDecoder"],(function(e,t,r,i,a,n,o,s,d,l,c,u,h,p){var f,w,g=(f=new ArrayBuffer(4),w=new Uint8Array(f),new Uint32Array(f)[0]=1,1===w[0]);function m(e,t){if(!g)throw new n("rasterCoded:decode","lerc decoder is not supported on big endian platform");for(var r,i,a=t.width,s=t.height,d=t.pixelType,l=A(d),u=l.pixelTypeCtor,h=null==t.noDataValue?l.noDataValue:t.noDataValue,p=0,f=0,w=e.byteLength-10;f<w;){var m=c.decode(e,{inputOffset:f,encodedMaskData:r,returnMask:0===p,returnEncodedMask:0===p,returnFileInfo:!0,pixelType:u,noDataValue:h});if(a&&s&&(m.width!==a||m.height!==s))throw new n("rasterCoded:decode","lerc decoded result has width or height different from specified in options");if(f=m.fileInfo.eofOffset,0===p&&(r=m.encodedMaskData,i=new o({width:m.width,height:m.height,pixels:[],pixelType:d,mask:m.maskData,statistics:[]})),p++,i.addData({pixels:m.pixelData,statistics:{minValue:m.minValue,maxValue:m.maxValue,noDataValue:m.noDataValue}}),w-f>10){var x=String.fromCharCode.apply(null,new Uint8Array(e,f,10));f=f+x.indexOf("CntZ")>-1?x.indexOf("CntZ"):0}}return i}function x(e,t){if(!g)throw new n("rasterCoded:decode","lerc decoder is not supported on big endian platform");for(var r,i,a,s=0,d=0,c=0,u=e.byteLength-10,h=[],p=t.width,f=t.height;d<u;){if(i=l.decode(e,{inputOffset:d,maskData:r,returnFileInfo:!0}),p&&f&&(i.width!==p||i.height!==f))throw new n("rasterCoded:decode","lerc2 decoded result has width or height different from what's specified in options");if(d=i.fileInfo.eofOffset,0===s&&(c=i.fileInfo.numValidPixel,r=i.maskData,a=new o({width:i.width,height:i.height,pixels:[],pixelType:i.fileInfo.pixelType,mask:i.maskData,statistics:[]})),i.fileInfo.mask&&i.fileInfo.mask.numBytes>0&&h.push(i.maskData),s++,a.addData({pixels:i.pixelData,statistics:{minValue:i.minValue,maxValue:i.maxValue}}),u-d>10){var w=String.fromCharCode.apply(null,new Uint8Array(e,d,10));d+=w.indexOf("Lerc")>-1?w.indexOf("Lerc"):0}}var m=0,x=0,y=0;if(h.length>1){for(y=a.width*a.height,(r=new Uint8Array(y)).set(h[0]),m=1;m<h.length;m++){var k=h[m];for(x=0;x<y;x++)r[x]=r[x]&k[x]}for(c=0,x=0;x<y;x++)c+=r[x];a.mask=r}return a.validPixelCount=c,a}function y(e){var t=p.decode(e),r=new o({width:t.width,height:t.height,pixels:t.pixels,pixelType:t.pixelType.toLowerCase(),mask:t.mask,statistics:null});return r.updateStatistics(),r}function k(e,t){var r=p.decodeTileOrStrip(e,t.customOptions),i=new o({width:r.width,height:r.height,pixels:r.pixels,pixelType:r.pixelType.toLowerCase(),mask:r.mask,statistics:null});return i.updateStatistics(),i}function C(e){var t=d.decode(e),r=new o({width:t.width,height:t.height,pixels:t.pixels,pixelType:"U8",mask:t.mask,statistics:null});return r.updateStatistics(),r}function v(e,t){var r,i=new Uint8Array(e),a=new u(i),n=t.width,s=t.height,d=n*s,l=a.decode(),c=0,h=0,p=new Uint8Array(d);for(c=0;c<d;c++)p[c]=l[4*c+3];var f=new o({width:n,height:s,pixels:[],pixelType:"U8",mask:p,statistics:[]});for(c=0;c<3;c++){for(r=new Uint8Array(d),h=0;h<d;h++)r[h]=l[4*h+c];f.addData({pixels:r})}return f.updateStatistics(),f}function b(e,t,n){return i(this,void 0,void 0,(function(){var i,d,l,c;return r(this,(function(r){switch(r.label){case 0:return i=new s,d=a({applyJpegMask:!1},t),[4,i.decode(e,d,n)];case 1:return l=r.sent(),(c=new o(l)).updateStatistics(),[2,c]}}))}))}function D(e){if(null==e)throw new n("rasterCodec:decode","parameter encodeddata is required.");var t=new Uint8Array(e,0,10),r="";return 255===t[0]&&216===t[1]?r="jpg":137===t[0]&&80===t[1]&&78===t[2]&&71===t[3]?r="png":67===t[0]&&110===t[1]&&116===t[2]&&90===t[3]&&73===t[4]&&109===t[5]&&97===t[6]&&103===t[7]&&101===t[8]&&32===t[9]?r="lerc":76===t[0]&&101===t[1]&&114===t[2]&&99===t[3]&&50===t[4]&&32===t[5]?r="lerc2":73===t[0]&&73===t[1]&&42===t[2]&&0===t[3]||77===t[0]&&77===t[1]&&0===t[2]&&42===t[3]?r="tiff":String.fromCharCode.apply(null,t).toLowerCase().indexOf("error")>-1&&(r="error"),r}function T(e){var t=null;switch(e){case"lerc":t=m;break;case"lerc2":t=x;break;case"jpg":t=C;break;case"png":t=v;break;case"bsq":case"bip":t=function(t,r){return function(e,t,r){var i=A(t.pixelType).pixelTypeCtor,a=(0,h.decode)(e,{width:t.width,height:t.height,pixelType:i,format:r}),n=new o({width:t.width,height:t.height,pixels:a.pixels,pixelType:t.pixelType,mask:a.mask,statistics:null});return n.updateStatistics(),n}(t,r,e)};break;case"tiff":t=y;break;case"error":t=function(){throw new n("rasterCodec:decode","input data contains error")};break;default:t=function(){throw new n("rasterCodec:decode","unsupported raster format")}}return t}function A(e){var t=null,r=null;switch(e?e.toLowerCase():"f32"){case"u1":case"u2":case"u4":case"u8":r=Math.pow(2,8)-1,t=Uint8Array;break;case"u16":r=r||Math.pow(2,16)-1,t=Uint16Array;break;case"u32":r=r||Math.pow(2,32)-1,t=Uint32Array;break;case"s8":r=r||0-Math.pow(2,7),t=Int8Array;break;case"s16":r=r||0-Math.pow(2,15),t=Int16Array;break;case"s32":r=r||0-Math.pow(2,31),t=Int32Array;break;default:t=Float32Array}return{pixelTypeCtor:t,noDataValue:r}}return function(){function e(){}return e.getFormat=function(e){var t=D(e);return"lerc2"===t?t="lerc":"error"===t&&(t=""),t},e.decode=function(e,t,s){return i(this,void 0,void 0,(function(){var i,d,l;return r(this,(function(r){switch(r.label){case 0:if(null==e)throw new n("rasterCodec:decode","missing encodeddata parameter.");if(null==t||null==t.width||null==t.height)throw new n("rasterCodec:decode","requires width and height in options parameter.");return"tiff"===(i=t.format&&t.format.toLowerCase())&&t.customOptions?[2,k(e,t)]:((!i||"bsq"!==i&&"bip"!==i)&&(i=D(e)),!t.useCanvas||"jpg"!==i&&"png"!==i?[3,2]:[4,b(e,t,s)]);case 1:return l=r.sent(),[3,3];case 2:d=T(i),t.isPoint&&((t=a({},t)).width++,t.height++),l=d(e,t),t.isPoint&&function(e,t){if(void 0===t&&(t=1),e){var r=e.pixels,i=e.width,a=e.height,n=e.mask;if(r&&0!==r.length){var s,d,l,c,u,h,p,f=r.length,w=i-1,g=a-1,m=[],x=o.getPixelArrayConstructor(e.pixelType);if(0===t){for(s=0;s<f;s++){for(u=r[s],h=new x(w*g),d=0;d<g;d++)for(c=d*i,l=0;l<w;l++)h[d*w+l]=u[c+l];m.push(h)}if(n)for(p=new Uint8Array(w*g),d=0;d<g;d++)for(c=d*i,l=0;l<w;l++)p[d*w+l]=n[c+l]}else{for(s=0;s<f;s++){for(u=r[s],h=new x(w*g),d=0;d<g;d++)for(c=d*i,l=0;l<w;l++)h[d*w+l]=(u[c+l]+u[c+l+1]+u[c+i+l]+u[c+i+l+1])/4;m.push(h)}if(n)for(p=new Uint8Array(w*g),d=0;d<g;d++)for(c=d*i,l=0;l<w;l++)p[d*w+l]=Math.min.apply(null,[n[c+l],n[c+l+1],n[c+i+l],n[c+i+l+1]])}e.width=w,e.height=g,e.mask=p,e.pixels=m}}}(l),r.label=3;case 3:return[2,l]}}))}))},e}()}));