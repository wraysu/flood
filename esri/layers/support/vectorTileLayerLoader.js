// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/assignHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../config","../../request","../../core/promiseUtils","../../core/urlUtils","../../views/2d/engine/vectorTiles/style/VectorTileSource"],(function(e,r,t,l,s,o,n,i,u,a){Object.defineProperty(r,"__esModule",{value:!0});var c=o.defaults&&o.defaults.io.corsEnabledServers;function f(e){if(e){var r=u.getOrigin(e);c&&-1===c.indexOf(r)&&c.push(r)}}function p(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];for(var t=void 0,l=0;l<e.length;++l)if(u.isProtocolRelative(e[l])){if(t){var s=t.split("://")[0];t=s+":"+e[l].trim()}}else t=u.isAbsolute(e[l])?e[l]:u.join(t,e[l]);return u.removeTrailingSlash(t)}function y(e,r,o,a,c){return s(this,void 0,void 0,(function(){var s,p,y,v,S,U;return l(this,(function(l){switch(l.label){case 0:return i.throwIfAborted(c),"string"!=typeof o?[3,2]:(f(v=u.normalize(o)),S=u.urlToObject(v),[4,n(S.path,t({query:{f:"json"},responseType:"json"},c))]);case 1:return y=l.sent(),s=v,p=v,[3,3];case 2:y={data:o},s=o.jsonUrl||null,p=a,l.label=3;case 3:return U=y.data,y.ssl&&(s&&(s=s.replace(/^http:/i,"https:")),p&&(p=p.replace(/^http:/i,"https:"))),d(U)?(e.styleUrl=s||null,[2,m(e,U,p,c)]):d(U)?[2,i.reject("You must specify the URL or the JSON for a service or for a style.")]:e.sourceUrl?[2,h(e,U,p,!1,r,c)]:(e.sourceUrl=s||null,[2,h(e,U,p,!0,r,c)])}}))}))}function d(e){return!!e.sources}function m(e,r,t,o){return s(this,void 0,void 0,(function(){var s,n,a,c,d,m;return l(this,(function(l){switch(l.label){case 0:return s=t?u.removeFile(t):u.appBaseUrl,e.styleBase=s,e.style=r,e.styleUrl&&f(e.styleUrl),n=[],r.sources&&r.sources.esri?(a=r.sources.esri).url?[4,y(e,"esri",p(s,a.url),void 0,o)]:[3,2]:[3,3];case 1:return l.sent(),[3,3];case 2:n.push(y(e,"esri",a,s,o)),l.label=3;case 3:for(c=0,d=Object.keys(r.sources);c<d.length;c++)"esri"!==(m=d[c])&&"vector"===r.sources[m].type&&(r.sources[m].url?n.push(y(e,m,p(s,r.sources[m].url),void 0,o)):n.push(y(e,m,r.sources[m],s,o)));return[4,i.all(n)];case 4:return l.sent(),[2]}}))}))}function h(e,r,t,o,n,c){return s(this,void 0,void 0,(function(){var s,d,m,h;return l(this,(function(l){if(s=t?u.removeTrailingSlash(t)+"/":u.appBaseUrl,d=function(e,r){if(e.hasOwnProperty("tileInfo"))return e;for(var t={xmin:-20037507.067161843,ymin:-20037507.067161843,xmax:20037507.067161843,ymax:20037507.067161843,spatialReference:{wkid:102100}},l=78271.51696400007,s=295828763.7957775,o=[],n=e.hasOwnProperty("minzoom")?parseFloat(e.minzoom):0,i=e.hasOwnProperty("maxzoom")?parseFloat(e.maxzoom):22,u=0;u<=i;u++)u>=n&&o.push({level:u,scale:s,resolution:l}),l/=2,s/=2;for(var a=0,c=e.tiles;a<c.length;a++){var y=c[a];f(p(r,y))}return{capabilities:"TilesOnly",initialExtent:t,fullExtent:t,minScale:0,maxScale:0,tiles:e.tiles,tileInfo:{rows:512,cols:512,dpi:96,format:"pbf",origin:{x:-20037508.342787,y:20037508.342787},lods:o,spatialReference:{wkid:102100}}}}(r,s),m=new a(n,s,d),!o&&e.primarySourceName in e.sourceNameToSource){if(!(h=e.sourceNameToSource[e.primarySourceName]).isCompatibleWith(m))return[2,i.resolve()];null!=m.fullExtent&&(null!=h.fullExtent?h.fullExtent.union(m.fullExtent):h.fullExtent=m.fullExtent.clone()),h.tileInfo.lods.length<m.tileInfo.lods.length&&(h.tileInfo=m.tileInfo)}return o?(e.sourceBase=s,e.source=r,e.validatedSource=d,e.primarySourceName=n,e.sourceUrl&&f(e.sourceUrl)):f(s),e.sourceNameToSource[n]=m,e.style?[2]:null==r.defaultStyles?[2,i.reject()]:"string"==typeof r.defaultStyles?[2,y(e,"",p(s,r.defaultStyles,"root.json"),void 0,c)]:[2,y(e,"",r.defaultStyles,p(s,"root.json"),c)]}))}))}r.loadMetadata=function(e,r){return s(this,void 0,void 0,(function(){var t,s,o,n,i,a;return l(this,(function(l){switch(l.label){case 0:return t={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:""},s="string"==typeof e?[e,null]:[null,e.jsonUrl],n=s[1],i=(o=s[0])?u.urlToObject(o):null,[4,y(t,"esri",e,n,r)];case 1:return l.sent(),f((a={layerDefinition:t.validatedSource,url:o,parsedUrl:i,serviceUrl:t.sourceUrl,style:t.style,styleUrl:t.styleUrl,spriteUrl:t.style.sprite&&p(t.styleBase,t.style.sprite),glyphsUrl:t.style.glyphs&&p(t.styleBase,t.style.glyphs),sourceNameToSource:t.sourceNameToSource,primarySourceName:t.primarySourceName}).spriteUrl),f(a.glyphsUrl),[2,a]}}))}))}}));